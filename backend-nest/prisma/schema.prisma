// Prisma Schema for Portal - Multi-Tenant B2B SaaS
// Database: PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========================================
// AUTHENTICATION & USER MANAGEMENT
// ========================================

model User {
  id        String  @id @default(uuid())
  email     String  @unique
  password  String? // Nullable for OAuth-only users
  firstName String?
  lastName  String?
  name      String? // Full name for analytics
  avatar    String?

  // OAuth providers
  googleId    String? @unique
  githubId    String? @unique
  firebaseUid String? @unique

  // Email verification
  emailVerified      Boolean   @default(false)
  emailVerifyToken   String?   @unique
  emailVerifyExpiry  DateTime?

  // Password reset
  resetToken       String?   @unique
  resetTokenExpiry DateTime?

  // Security
  twoFactorEnabled  Boolean  @default(false)
  twoFactorSecret   String?
  passwordChangedAt DateTime?
  failedLoginCount  Int      @default(0)
  lockedUntil       DateTime?

  // Multi-tenant relationship
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  // Roles & Permissions
  role WorkspaceRole @default(MEMBER)

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  lastLoginAt DateTime?

  // Relations
  createdPortals     Portal[]
  shareLinks         ShareLink[]
  alerts             Alert[]
  scheduledReports   ScheduledReport[]
  webhooks           Webhook[]
  comments           Comment[]
  workspaceMembers   WorkspaceMember[]
  sessions           UserSession[]
  auditLogs          AuditLog[]       @relation("UserAuditLogs")
  apiKeys            ApiKey[]

  @@index([workspaceId])
  @@index([email])
  @@index([googleId])
  @@index([githubId])
  @@index([firebaseUid])
  @@map("users")
}

enum WorkspaceRole {
  OWNER
  ADMIN
  MEMBER
}

// ========================================
// WORKSPACE (TENANT)
// ========================================

model Workspace {
  id   String @id @default(uuid())
  name String
  slug String @unique // URL-friendly name

  // Branding
  logo         String? // S3/R2 URL
  primaryColor String  @default("#3B82F6") // Hex color

  // Contact & Metadata
  contactEmail String?
  website      String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  users                 User[]
  portals               Portal[]
  integrations          Integration[]
  subscription          Subscription?
  alerts                Alert[]
  scheduledReports      ScheduledReport[]
  webhooks              Webhook[]
  aiInsights            AIInsight[]
  members               WorkspaceMember[]
  dataSourceHealth      DataSourceHealth[]
  dataValidationRules   DataValidationRule[]
  projects              Project[]
  clientReports         ClientReport[]
  gdprConsents          GDPRConsent[]
  gdprDataRequests      GDPRDataRequest[]
  complianceReports     ComplianceReport[]

  @@map("workspaces")
}

// ========================================
// SUBSCRIPTION & BILLING
// ========================================

model Subscription {
  id String @id @default(uuid())

  // Workspace relationship
  workspaceId String    @unique
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  // Stripe
  stripeCustomerId       String    @unique
  stripeSubscriptionId   String?   @unique
  stripePriceId          String?
  stripeCurrentPeriodEnd DateTime?
  currentPeriodStart     DateTime?

  // Plan details
  plan   SubscriptionPlan   @default(TRIAL)
  status SubscriptionStatus @default(TRIALING)

  // Limits
  maxPortals Int @default(5)
  maxUsers   Int @default(1)

  // Trial
  trialEndsAt DateTime?

  // Timestamps
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  canceledAt DateTime?

  @@index([workspaceId])
  @@index([stripeCustomerId])
  @@map("subscriptions")
}

enum SubscriptionPlan {
  TRIAL
  PRO // $49/mo - 5 portals, 1 user
  AGENCY // $99/mo - 15 portals, 5 users
}

enum SubscriptionStatus {
  TRIALING
  ACTIVE
  PAST_DUE
  CANCELED
  CANCELLED
  INCOMPLETE
  INCOMPLETE_EXPIRED
  UNPAID
}

// ========================================
// INTEGRATIONS (OAuth Connections)
// ========================================

model Integration {
  id String @id @default(uuid())

  // Workspace relationship
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  // Provider details
  provider IntegrationProvider

  // OAuth tokens (ENCRYPTED in application layer)
  accessToken  String    @db.Text
  refreshToken String?   @db.Text
  expiresAt    DateTime?

  // Provider-specific metadata
  accountId   String? // e.g., Asana workspace GID, GA property ID
  accountName String? // Display name
  scopes      String? // Granted OAuth scopes

  // Settings (JSON for provider-specific config)
  settings Json @default("{}")

  // Status
  status        IntegrationStatus @default(ACTIVE)
  lastSyncedAt  DateTime?
  lastSyncError String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  widgets              Widget[]
  dataSourceHealth     DataSourceHealth?
  dataValidationRules  DataValidationRule[]

  @@unique([workspaceId, provider])
  @@index([workspaceId])
  @@index([status])
  @@map("integrations")
}

enum IntegrationProvider {
  ASANA
  CLICKUP
  TRELLO
  GOOGLE_ANALYTICS
  GOOGLE_ANALYTICS_4
  HARVEST
  TOGGL
  GITHUB
  JIRA
  HUBSPOT
  SLACK
  MONDAY
  NOTION
  STRIPE
}

enum IntegrationStatus {
  ACTIVE
  INACTIVE
  ERROR
  EXPIRED
}

// ========================================
// PORTALS (The Core Product)
// ========================================

model Portal {
  id String @id @default(uuid())

  // Workspace relationship
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  // Portal details
  name        String
  slug        String // Unique per workspace - used in public URL
  description String?

  // Public sharing
  isPublic   Boolean @default(true)
  shareToken String  @unique @default(uuid()) // Used in public URL: portal.to/v/{shareToken}

  // Layout configuration (JSON)
  layout Json @default("[]") // Array of widget positions/sizes for react-grid-layout

  // Creator
  createdById String
  createdBy   User   @relation(fields: [createdById], references: [id], onDelete: Cascade)

  // Cache settings
  cacheRefreshInterval Int       @default(30) // Minutes
  lastCachedAt         DateTime?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  widgets          Widget[]
  shareLinks       ShareLink[]
  scheduledReports ScheduledReport[]
  aiInsights       AIInsight[]

  @@unique([workspaceId, slug])
  @@index([workspaceId])
  @@index([shareToken])
  @@map("portals")
}

// ========================================
// WIDGETS (Portal Building Blocks)
// ========================================

model Widget {
  id String @id @default(uuid())

  // Portal relationship
  portalId String
  portal   Portal @relation(fields: [portalId], references: [id], onDelete: Cascade)

  // Widget details
  name String

  // Widget type
  type WidgetType

  // Configuration (JSON - varies by widget type)
  config Json @default("{}")
  // Examples:
  // Text: { content: "...", format: "markdown" }
  // Asana Task List: { projectId: "...", filter: "in_progress" }
  // GA Metric: { metric: "users", period: "30d" }

  // Grid position (redundant with portal.layout, but useful for queries)
  gridX      Int @default(0)
  gridY      Int @default(0)
  gridWidth  Int @default(4)
  gridHeight Int @default(4)

  // Refresh settings
  refreshInterval Int       @default(300) // Seconds
  lastRefreshedAt DateTime?

  // Integration relationship (optional)
  integrationId String?
  integration   Integration? @relation(fields: [integrationId], references: [id], onDelete: SetNull)

  // Display order
  order Int @default(0)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([portalId])
  @@index([integrationId])
  @@map("widgets")
}

enum WidgetType {
  // Static widgets
  TEXT_BLOCK
  IMAGE
  VIDEO_EMBED

  // Asana widgets
  ASANA_TASK_LIST
  ASANA_PROJECT_PROGRESS

  // ClickUp widgets
  CLICKUP_TASK_LIST
  CLICKUP_PROJECT_PROGRESS

  // Trello widgets
  TRELLO_CARD_LIST
  TRELLO_BOARD_PROGRESS

  // Google Analytics 4 widgets
  GA4_METRIC_KPI
  GA4_LINE_GRAPH
  GA4_TOP_PAGES

  // Harvest widgets
  HARVEST_BUDGET_TRACKER
  HARVEST_TOTAL_HOURS

  // Toggl widgets
  TOGGL_TOTAL_HOURS
}

// ========================================
// CACHE STORAGE (For fast public portal loads)
// ========================================
// Note: Actual cache data stored in Redis
// This table stores metadata about cache jobs

model CacheJob {
  id String @id @default(uuid())

  // Portal reference
  portalId String

  // Job status
  status CacheJobStatus @default(PENDING)

  // Error tracking
  error      String?
  retryCount Int     @default(0)
  maxRetries Int     @default(3)

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  startedAt   DateTime?
  completedAt DateTime?
  failedAt    DateTime?

  @@index([portalId])
  @@index([status])
  @@map("cache_jobs")
}

enum CacheJobStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
}

// ========================================
// AUDIT LOGS (Enterprise Security Feature)
// ========================================

model AuditLog {
  id String @id @default(uuid())

  // Workspace & User tracking
  workspaceId String
  userId      String?
  userEmail   String
  user        User?         @relation("UserAuditLogs", fields: [userId], references: [id])

  // Action details
  action   AuditAction
  entity   String // e.g., "Portal", "Widget", "User"
  entityId String // ID of the affected resource

  // Request metadata
  ipAddress String?
  userAgent String?
  method    String // HTTP method: GET, POST, PUT, DELETE
  endpoint  String // API endpoint called

  // Changes tracking (JSON)
  oldValues Json? // Previous state
  newValues Json? // New state

  // Additional metadata
  metadata Json? // Any extra context

  // Status
  success      Boolean @default(true)
  errorMessage String?

  // Timestamp
  createdAt DateTime @default(now())

  @@index([workspaceId])
  @@index([userId])
  @@index([action])
  @@index([entity])
  @@index([createdAt])
  @@map("audit_logs")
}

enum AuditAction {
  // Authentication
  LOGIN
  LOGOUT
  PASSWORD_RESET

  // CRUD operations
  CREATE
  READ
  UPDATE
  DELETE

  // Specific actions
  INVITE_USER
  REMOVE_USER
  UPLOAD_FILE
  EXPORT_DATA
  CHANGE_SETTINGS
  CONNECT_INTEGRATION
  DISCONNECT_INTEGRATION
}

// ========================================
// ANALYTICS & TRACKING
// ========================================

model AnalyticsEvent {
  id String @id @default(uuid())

  // Workspace & Portal tracking
  workspaceId String
  portalId    String?
  widgetId    String?

  // User tracking
  userId    String?
  sessionId String // Browser session ID

  // Event details
  eventType String // e.g., "portal_view", "widget_click", "widget_view"
  eventData Json? // Additional event-specific data

  // Request metadata
  ipAddress String?
  userAgent String?
  referrer  String? // Where the user came from

  // Timestamp
  timestamp DateTime @default(now())

  @@index([workspaceId])
  @@index([portalId])
  @@index([widgetId])
  @@index([eventType])
  @@index([timestamp])
  @@index([sessionId])
  @@map("analytics_events")
}

// ========================================
// WORKSPACE MEMBERS (Enhanced RBAC)
// ========================================

model WorkspaceMember {
  id String @id @default(uuid())

  // Relationships
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Role & Permissions
  role WorkspaceMemberRole @default(VIEWER)

  // Invitation tracking
  invitedBy  String?
  invitedAt  DateTime  @default(now())
  acceptedAt DateTime?

  // Status
  status MemberStatus @default(PENDING)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([workspaceId, userId])
  @@index([workspaceId])
  @@index([userId])
  @@map("workspace_members")
}

enum WorkspaceMemberRole {
  OWNER
  ADMIN
  EDITOR
  VIEWER
}

enum MemberStatus {
  PENDING
  ACTIVE
  SUSPENDED
}

// ========================================
// BACKGROUND JOBS METADATA
// ========================================

model JobMetadata {
  id String @id @default(uuid())

  // Job details
  jobId     String @unique // BullMQ job ID
  queueName String // Which queue: email, report, data-sync
  jobType   String // Specific job type

  // Workspace tracking
  workspaceId String
  userId      String?

  // Status
  status   JobStatus @default(QUEUED)
  progress Int       @default(0) // 0-100

  // Timing
  queuedAt    DateTime  @default(now())
  startedAt   DateTime?
  completedAt DateTime?
  failedAt    DateTime?

  // Results
  result Json? // Job result data
  error  String? // Error message if failed

  // Metadata
  metadata Json? // Additional context

  @@index([workspaceId])
  @@index([userId])
  @@index([status])
  @@index([queueName])
  @@map("job_metadata")
}

enum JobStatus {
  QUEUED
  ACTIVE
  COMPLETED
  FAILED
  DELAYED
  PAUSED
}

// ========================================
// NOTIFICATIONS
// ========================================

model Notification {
  id String @id @default(uuid())

  // Recipient
  userId      String
  workspaceId String

  // Notification details
  title   String
  message String
  type    NotificationType

  // Action link
  actionUrl String?

  // Status
  read   Boolean   @default(false)
  readAt DateTime?

  // Related entities
  portalId String?
  widgetId String?

  // Metadata
  metadata Json?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([workspaceId])
  @@index([read])
  @@index([createdAt])
  @@map("notifications")
}

enum NotificationType {
  INFO
  SUCCESS
  WARNING
  ERROR
  PORTAL_CREATED
  PORTAL_UPDATED
  PORTAL_DELETED
  WIDGET_ADDED
  WIDGET_UPDATED
  MEMBER_INVITED
  INTEGRATION_SYNCED
  INTEGRATION_FAILED
  ALERT_TRIGGERED
  REPORT_GENERATED
}

// ========================================
// PUBLIC SHARE LINKS
// ========================================

model ShareLink {
  id String @id @default(uuid())

  // Portal reference
  portalId String
  portal   Portal @relation(fields: [portalId], references: [id], onDelete: Cascade)

  // Share token (URL-friendly)
  token String @unique @default(uuid())

  // Access control
  password     String? // Hashed password for protected links
  expiresAt    DateTime?
  maxViews     Int? // Limit number of views
  currentViews Int       @default(0)

  // Permissions
  allowExport   Boolean @default(false) // Allow export from shared link
  allowComments Boolean @default(false)

  // Creator
  createdById String
  createdBy   User   @relation(fields: [createdById], references: [id], onDelete: Cascade)

  // Status
  isActive Boolean @default(true)

  // Analytics
  lastAccessedAt DateTime?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([portalId])
  @@index([token])
  @@index([isActive])
  @@map("share_links")
}

// ========================================
// ALERTS & MONITORING
// ========================================

model Alert {
  id String @id @default(uuid())

  // Workspace & Portal
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  portalId    String?
  widgetId    String?

  // Alert configuration
  name        String
  description String?
  condition   Json // {metric: "value", operator: ">", threshold: 100}
  severity    AlertSeverity @default(MEDIUM)
  
  // Notification channels
  channels Json // ["email", "slack", "webhook"]
  
  // Email settings
  emailRecipients String[] // List of emails
  
  // Webhook settings
  webhookUrl String?
  
  // Slack settings
  slackWebhook String?
  slackChannel String?

  // Status
  isActive Boolean @default(true)
  
  // Tracking
  lastTriggeredAt DateTime?
  triggerCount    Int       @default(0)

  // Creator
  createdById String
  createdBy   User   @relation(fields: [createdById], references: [id], onDelete: Cascade)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  history AlertHistory[]

  @@index([workspaceId])
  @@index([portalId])
  @@index([isActive])
  @@map("alerts")
}

model AlertHistory {
  id String @id @default(uuid())

  // Alert reference
  alertId String
  alert   Alert  @relation(fields: [alertId], references: [id], onDelete: Cascade)

  // Trigger details
  triggeredValue Json // The actual value that triggered the alert
  condition      Json // Copy of condition at trigger time
  
  // Notification status
  notificationsSent Json // {email: true, slack: false, webhook: true}
  
  // Timestamp
  triggeredAt DateTime @default(now())

  @@index([alertId])
  @@index([triggeredAt])
  @@map("alert_history")
}

// ========================================
// SCHEDULED REPORTS
// ========================================

model ScheduledReport {
  id String @id @default(uuid())

  // Workspace & Portal
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  portalId    String
  portal      Portal    @relation(fields: [portalId], references: [id], onDelete: Cascade)

  // Report configuration
  name        String
  description String?
  format      ReportFormat @default(PDF)
  
  // Schedule (cron expression)
  schedule String // e.g., "0 9 * * 1" for every Monday at 9 AM
  timezone String @default("UTC")

  // Recipients
  recipients String[] // Email addresses
  
  // Template
  templateId String?
  customTemplate Json? // Custom report template configuration

  // Status
  isActive Boolean @default(true)
  
  // Tracking
  lastRunAt     DateTime?
  nextRunAt     DateTime?
  lastRunStatus ReportStatus?
  runCount      Int          @default(0)

  // Creator
  createdById String
  createdBy   User   @relation(fields: [createdById], references: [id], onDelete: Cascade)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  runs ReportRun[]

  @@index([workspaceId])
  @@index([portalId])
  @@index([isActive])
  @@index([nextRunAt])
  @@map("scheduled_reports")
}

model ReportRun {
  id String @id @default(uuid())

  // Report reference
  reportId String
  report   ScheduledReport @relation(fields: [reportId], references: [id], onDelete: Cascade)

  // Execution details
  status    ReportStatus @default(PENDING)
  startedAt DateTime?
  completedAt DateTime?
  
  // Output
  fileUrl String? // S3/R2 URL if stored
  fileSize Int? // Bytes
  
  // Error tracking
  error String?
  
  // Metadata
  recipientsSent String[] // Successfully sent to these emails
  metadata       Json?

  // Timestamp
  createdAt DateTime @default(now())

  @@index([reportId])
  @@index([status])
  @@index([createdAt])
  @@map("report_runs")
}

enum ReportFormat {
  PDF
  CSV
  EXCEL
  JSON
}

enum ReportStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
  PARTIALLY_SENT
}

// ========================================
// WEBHOOKS
// ========================================

model Webhook {
  id String @id @default(uuid())

  // Workspace
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  // Webhook configuration
  name        String
  url         String
  secret      String? // For signature verification
  events      String[] // List of events to subscribe to
  
  // Headers
  headers Json? // Custom headers to send
  
  // Retry configuration
  maxRetries     Int @default(3)
  retryDelay     Int @default(60) // Seconds
  timeoutSeconds Int @default(30)

  // Status
  isActive Boolean @default(true)
  
  // Tracking
  lastTriggeredAt DateTime?
  successCount    Int       @default(0)
  failureCount    Int       @default(0)

  // Creator
  createdById String
  createdBy   User   @relation(fields: [createdById], references: [id], onDelete: Cascade)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  deliveries WebhookDelivery[]

  @@index([workspaceId])
  @@index([isActive])
  @@map("webhooks")
}

model WebhookDelivery {
  id String @id @default(uuid())

  // Webhook reference
  webhookId String
  webhook   Webhook @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  // Event details
  event     String
  payload   Json
  
  // Delivery attempt
  attempts      Int       @default(0)
  lastAttemptAt DateTime?
  nextAttemptAt DateTime?
  
  // Response
  status         WebhookStatus @default(PENDING)
  responseCode   Int?
  responseBody   String?
  responseTime   Int? // Milliseconds
  
  // Error
  error String?

  // Timestamp
  createdAt DateTime @default(now())

  @@index([webhookId])
  @@index([status])
  @@index([event])
  @@index([nextAttemptAt])
  @@map("webhook_deliveries")
}

enum WebhookStatus {
  PENDING
  SUCCESS
  FAILED
  RETRYING
}

// ========================================
// COMMENTS & COLLABORATION
// ========================================

model Comment {
  id String @id @default(uuid())

  // Location
  portalId String
  widgetId String?
  
  // Author
  authorId String
  author   User   @relation(fields: [authorId], references: [id], onDelete: Cascade)

  // Content
  content  String   @db.Text
  mentions String[] // User IDs mentioned in comment
  
  // Thread
  parentId String?
  parent   Comment?  @relation("CommentThread", fields: [parentId], references: [id], onDelete: Cascade)
  replies  Comment[] @relation("CommentThread")
  
  // Status
  isEdited  Boolean   @default(false)
  isDeleted Boolean   @default(false)
  editedAt  DateTime?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([portalId])
  @@index([widgetId])
  @@index([authorId])
  @@index([parentId])
  @@map("comments")
}

// ========================================
// AI INSIGHTS
// ========================================

model AIInsight {
  id String @id @default(uuid())

  // Workspace & Portal
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  portalId    String
  portal      Portal    @relation(fields: [portalId], references: [id], onDelete: Cascade)

  // Insight details
  type        InsightType
  title       String
  description String      @db.Text
  severity    InsightSeverity @default(INFO)
  confidence  Float // 0.0 to 1.0
  
  // Data
  data Json // Supporting data for the insight
  
  // Recommendations
  recommendations Json? // Suggested actions
  
  // Status
  status     InsightStatus @default(NEW)
  dismissedBy String?
  dismissedAt DateTime?
  
  // Validity
  validFrom DateTime @default(now())
  validUntil DateTime?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([workspaceId])
  @@index([portalId])
  @@index([type])
  @@index([status])
  @@map("ai_insights")
}

enum InsightType {
  ANOMALY
  TREND
  PREDICTION
  RECOMMENDATION
  SUMMARY
}

enum InsightSeverity {
  INFO
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum InsightStatus {
  NEW
  VIEWED
  ACTIONED
  DISMISSED
}

// ========================================
// WIDGET TEMPLATES
// ========================================

model WidgetTemplate {
  id String @id @default(uuid())

  // Template details
  name        String
  description String?
  category    TemplateCategory
  thumbnail   String? // Preview image URL

  // Template configuration
  widgetType WidgetType
  config     Json // Default widget configuration
  layout     Json? // Default grid layout settings

  // Visibility
  isPublic    Boolean @default(false) // Available to all users
  workspaceId String? // Null if public template
  
  // Creator (null for system templates)
  createdById String?
  
  // Usage tracking
  usageCount Int @default(0)

  // Tags for filtering
  tags String[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category])
  @@index([widgetType])
  @@index([isPublic])
  @@index([workspaceId])
  @@map("widget_templates")
}

enum TemplateCategory {
  PROJECT_MANAGEMENT
  ANALYTICS
  TIME_TRACKING
  MARKETING
  SALES
  DEVELOPMENT
  CUSTOM
}

// ========================================
// BILLING & USAGE
// ========================================

model BillingEvent {
  id String @id @default(uuid())

  // Workspace
  workspaceId String
  
  // Stripe references
  stripeEventId      String? @unique
  stripeInvoiceId    String?
  stripePaymentIntentId String?
  
  // Event details
  type        BillingEventType
  amount      Int? // In cents
  currency    String @default("usd")
  description String?
  
  // Status
  status BillingEventStatus @default(PENDING)
  
  // Metadata
  metadata Json?

  // Timestamp
  createdAt DateTime @default(now())

  @@index([workspaceId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
  @@map("billing_events")
}

enum BillingEventType {
  SUBSCRIPTION_CREATED
  SUBSCRIPTION_UPDATED
  SUBSCRIPTION_CANCELED
  INVOICE_PAID
  INVOICE_FAILED
  PAYMENT_SUCCEEDED
  PAYMENT_FAILED
  TRIAL_ENDED
  PLAN_UPGRADED
  PLAN_DOWNGRADED
}

enum BillingEventStatus {
  PENDING
  COMPLETED
  FAILED
}

model UsageMetric {
  id String @id @default(uuid())

  // Workspace
  workspaceId String
  
  // Metric details
  metricType  UsageMetricType
  value       Float
  unit        String? // e.g., "count", "bytes", "ms"
  
  // Resource references
  portalId String?
  widgetId String?
  userId   String?
  
  // Time bucket
  period     DateTime // Rounded to hour/day for aggregation
  periodType PeriodType @default(HOURLY)
  
  // Metadata
  metadata Json?

  // Timestamp
  createdAt DateTime @default(now())

  @@index([workspaceId])
  @@index([metricType])
  @@index([period])
  @@index([portalId])
  @@map("usage_metrics")
}

enum UsageMetricType {
  PORTAL_VIEWS
  WIDGET_LOADS
  API_CALLS
  EXPORT_COUNT
  STORAGE_BYTES
  INTEGRATION_SYNCS
  REPORT_GENERATIONS
  AI_INSIGHTS_GENERATED
  BANDWIDTH_BYTES
  ACTIVE_USERS
}

enum PeriodType {
  HOURLY
  DAILY
  WEEKLY
  MONTHLY
}

// ========================================
// PORTAL TEMPLATES (Full Dashboard)
// ========================================

model PortalTemplate {
  id String @id @default(uuid())

  // Template details
  name        String
  description String?
  category    TemplateCategory
  thumbnail   String? // Preview image URL

  // Template configuration
  layout        Json // Widget layout configuration
  widgetConfigs Json // Array of widget configurations
  settings      Json? // Portal-level settings

  // Visibility
  isPublic    Boolean @default(false)
  workspaceId String? // Null if public template
  
  // Creator (null for system templates)
  createdById String?
  
  // Usage tracking
  usageCount Int @default(0)

  // Tags for filtering
  tags String[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category])
  @@index([isPublic])
  @@index([workspaceId])
  @@map("portal_templates")
}

enum AlertSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

// ========================================
// SECURITY MODELS
// ========================================

model UserSession {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Session details
  token        String   @unique
  refreshToken String?  @unique
  
  // Device/Client info
  ipAddress  String
  userAgent  String
  deviceType String?
  location   String?
  
  // Status
  isActive   Boolean  @default(true)
  lastActive DateTime @default(now())
  expiresAt  DateTime
  
  // Timestamps
  createdAt DateTime @default(now())
  
  @@index([userId])
  @@index([token])
  @@index([isActive])
  @@map("user_sessions")
}

model ApiKey {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspaceId String
  
  // Key details
  name        String
  keyHash     String   @unique
  keyPrefix   String   // First 8 chars for identification
  
  // Permissions
  scopes      String[]
  
  // Rate limiting
  rateLimit   Int      @default(1000)
  
  // Status
  isActive    Boolean  @default(true)
  lastUsedAt  DateTime?
  expiresAt   DateTime?
  
  // Timestamps
  createdAt   DateTime @default(now())
  revokedAt   DateTime?
  
  @@index([workspaceId])
  @@index([keyHash])
  @@index([isActive])
  @@map("api_keys")
}

model SecurityEvent {
  id        String   @id @default(uuid())
  
  // Event details
  eventType   String    // login_failed, suspicious_activity, etc.
  severity    String    // low, medium, high, critical
  
  // Actor
  userId      String?
  ipAddress   String
  userAgent   String?
  
  // Context
  resourceType String?
  resourceId   String?
  workspaceId  String?
  
  // Details
  description String
  metadata    Json?
  
  // Resolution
  resolved    Boolean   @default(false)
  resolvedAt  DateTime?
  resolvedBy  String?
  
  // Timestamps
  createdAt   DateTime  @default(now())
  
  @@index([eventType])
  @@index([severity])
  @@index([userId])
  @@index([ipAddress])
  @@index([createdAt])
  @@map("security_events")
}

model IpBlocklist {
  id        String   @id @default(uuid())
  
  ipAddress   String   @unique
  reason      String
  blockedBy   String?
  expiresAt   DateTime?
  
  createdAt   DateTime @default(now())
  
  @@index([ipAddress])
  @@index([expiresAt])
  @@map("ip_blocklist")
}

// ========================================
// SYSTEM METRICS & ANALYTICS
// ========================================

model SystemMetrics {
  id String @id @default(uuid())
  
  metricType String
  value      Float
  unit       String?
  timestamp  DateTime @default(now())
  metadata   Json?
  
  @@index([metricType])
  @@index([timestamp])
  @@map("system_metrics")
}

model RevenueMetrics {
  id String @id @default(uuid())
  
  metricType String
  value      Float
  currency   String @default("usd")
  timestamp  DateTime @default(now())
  metadata   Json?
  
  @@index([metricType])
  @@index([timestamp])
  @@map("revenue_metrics")
}

model UserActivityMetrics {
  id String @id @default(uuid())
  
  metricType String
  value      Float
  timestamp  DateTime @default(now())
  metadata   Json?
  
  @@index([metricType])
  @@index([timestamp])
  @@map("user_activity_metrics")
}

// ========================================
// DATA QUALITY & RELIABILITY FEATURES
// ========================================

model DataSourceHealth {
  id String @id @default(uuid())
  
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  
  integrationId String
  integration   Integration @relation(fields: [integrationId], references: [id], onDelete: Cascade)
  
  // Health Status
  status            HealthStatus @default(HEALTHY)
  lastCheckAt       DateTime @default(now())
  lastSuccessAt     DateTime?
  lastErrorAt       DateTime?
  consecutiveErrors Int @default(0)
  
  // Performance Metrics
  responseTime      Float? // milliseconds
  dataFreshness     Int? // minutes since last data update
  freshnessThreshold Int @default(60) // alert if data older than this
  
  // Error Tracking
  lastError         String?
  errorCount        Int @default(0)
  rateLimit         Boolean @default(false)
  rateLimitResetAt  DateTime?
  
  // Schema Tracking
  lastKnownSchema   Json? // Store data structure
  schemaChangedAt   DateTime?
  schemaChangeDetected Boolean @default(false)
  
  // Alerting
  alertsEnabled     Boolean @default(true)
  alertThreshold    Int @default(3) // consecutive errors before alert
  lastAlertSentAt   DateTime?
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  healthChecks      DataSourceHealthCheck[]
  
  @@unique([integrationId])
  @@index([workspaceId])
  @@index([status])
  @@index([lastCheckAt])
  @@map("data_source_health")
}

enum HealthStatus {
  HEALTHY
  DEGRADED
  DOWN
  RATE_LIMITED
  SCHEMA_CHANGED
}

model DataSourceHealthCheck {
  id String @id @default(uuid())
  
  dataSourceHealthId String
  dataSourceHealth   DataSourceHealth @relation(fields: [dataSourceHealthId], references: [id], onDelete: Cascade)
  
  timestamp         DateTime @default(now())
  status            HealthStatus
  responseTime      Float? // milliseconds
  errorMessage      String?
  dataFreshness     Int? // minutes
  recordsChecked    Int?
  
  metadata          Json?
  
  @@index([dataSourceHealthId])
  @@index([timestamp])
  @@map("data_source_health_checks")
}

model DataValidationRule {
  id String @id @default(uuid())
  
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  
  name            String
  description     String?
  enabled         Boolean @default(true)
  
  // Target
  integrationId   String?
  integration     Integration? @relation(fields: [integrationId], references: [id], onDelete: Cascade)
  dataSource      String? // Generic data source identifier
  fieldPath       String // JSON path to field to validate
  
  // Rule Type
  ruleType        ValidationRuleType
  
  // Rule Configuration
  config          Json // Rule-specific config (thresholds, allowed values, etc)
  
  // Severity
  severity        ValidationSeverity @default(WARNING)
  
  // Notifications
  notifyOnFailure Boolean @default(true)
  notifyEmails    String[] // Array of emails to notify
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  violations      DataValidationViolation[]
  
  @@index([workspaceId])
  @@index([enabled])
  @@map("data_validation_rules")
}

enum ValidationRuleType {
  NO_NEGATIVE_VALUES
  RANGE_CHECK
  SPIKE_DETECTION
  MISSING_FIELD
  REQUIRED_FIELD
  CROSS_SOURCE_CONSISTENCY
  CUSTOM_REGEX
  DATA_TYPE_CHECK
}

enum ValidationSeverity {
  INFO
  WARNING
  ERROR
  CRITICAL
}

model DataValidationViolation {
  id String @id @default(uuid())
  
  ruleId String
  rule   DataValidationRule @relation(fields: [ruleId], references: [id], onDelete: Cascade)
  
  timestamp       DateTime @default(now())
  fieldPath       String
  actualValue     String? // Stringified value
  expectedValue   String? // What was expected
  violationType   String
  severity        ValidationSeverity
  
  resolved        Boolean @default(false)
  resolvedAt      DateTime?
  resolvedBy      String?
  resolutionNotes String?
  
  metadata        Json?
  
  @@index([ruleId])
  @@index([timestamp])
  @@index([resolved])
  @@map("data_validation_violations")
}

// ========================================
// BUSINESS INTELLIGENCE FEATURES
// ========================================

model Project {
  id String @id @default(uuid())
  
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  
  name            String
  clientName      String
  description     String?
  
  // Financial
  budgetAmount    Float?
  hourlyRate      Float?
  currency        String @default("USD")
  
  // Status
  status          ProjectStatus @default(ACTIVE)
  startDate       DateTime?
  endDate         DateTime?
  
  // Tracking
  totalHours      Float @default(0)
  billableHours   Float @default(0)
  actualCosts     Float @default(0)
  
  metadata        Json?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  timeEntries     ProjectTimeEntry[]
  expenses        ProjectExpense[]
  profitability   ProjectProfitability?
  clientReports   ClientReport[]
  
  @@index([workspaceId])
  @@index([status])
  @@index([clientName])
  @@map("projects")
}

enum ProjectStatus {
  ACTIVE
  ON_HOLD
  COMPLETED
  CANCELLED
}

model ProjectTimeEntry {
  id String @id @default(uuid())
  
  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  userId      String
  description String?
  
  hours       Float
  billable    Boolean @default(true)
  hourlyRate  Float?
  
  date        DateTime
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([projectId])
  @@index([date])
  @@map("project_time_entries")
}

model ProjectExpense {
  id String @id @default(uuid())
  
  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  description String
  amount      Float
  category    String?
  billable    Boolean @default(true)
  
  date        DateTime
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([projectId])
  @@index([date])
  @@map("project_expenses")
}

model ProjectProfitability {
  id String @id @default(uuid())
  
  projectId String @unique
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  // Revenue
  totalRevenue      Float @default(0)
  billableRevenue   Float @default(0)
  
  // Costs
  laborCosts        Float @default(0)
  expenseCosts      Float @default(0)
  totalCosts        Float @default(0)
  
  // Profitability
  grossProfit       Float @default(0)
  profitMargin      Float @default(0) // Percentage
  
  // Efficiency
  utilizationRate   Float @default(0) // Percentage
  billableRatio     Float @default(0) // Percentage
  
  // Scoring
  profitabilityScore Float @default(0) // 0-100
  
  lastCalculatedAt  DateTime @default(now())
  
  @@index([profitabilityScore])
  @@map("project_profitability")
}

model ClientReport {
  id String @id @default(uuid())
  
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  
  projectId String?
  project   Project? @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  title           String
  clientName      String
  reportType      ReportType @default(WEEKLY)
  
  // Content
  executiveSummary String?
  keyInsights      Json? // Array of insight objects
  metrics          Json? // Key metrics data
  recommendations  Json? // Array of recommendations
  
  // Generation
  aiGenerated     Boolean @default(false)
  generatedBy     String?
  
  // Delivery
  status          ClientReportStatus @default(DRAFT)
  scheduledFor    DateTime?
  sentAt          DateTime?
  recipientEmails String[]
  
  // Attachments
  pdfUrl          String?
  presentationUrl String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([workspaceId])
  @@index([projectId])
  @@index([status])
  @@index([scheduledFor])
  @@map("client_reports")
}

enum ReportType {
  DAILY
  WEEKLY
  MONTHLY
  QUARTERLY
  MILESTONE
  CUSTOM
}

enum ClientReportStatus {
  DRAFT
  SCHEDULED
  GENERATING
  SENT
  FAILED
}

// ========================================
// GDPR COMPLIANCE & SECURITY
// ========================================

model GDPRConsent {
  id String @id @default(uuid())
  
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  
  userId      String?
  
  // Subject Info
  subjectEmail String
  subjectName  String?
  
  // Consent Details
  consentType     ConsentType
  purpose         String
  consented       Boolean @default(false)
  consentedAt     DateTime?
  
  // Tracking
  ipAddress       String?
  userAgent       String?
  
  // Revocation
  revokedAt       DateTime?
  revocationReason String?
  
  // Expiry
  expiresAt       DateTime?
  
  metadata        Json?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([workspaceId])
  @@index([subjectEmail])
  @@index([consentType])
  @@map("gdpr_consents")
}

enum ConsentType {
  DATA_PROCESSING
  MARKETING
  ANALYTICS
  THIRD_PARTY_SHARING
  PROFILING
}

model GDPRDataRequest {
  id String @id @default(uuid())
  
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  
  // Requester Info
  requesterEmail  String
  requesterName   String?
  
  // Request Details
  requestType     GDPRRequestType
  status          GDPRRequestStatus @default(PENDING)
  
  // Processing
  submittedAt     DateTime @default(now())
  processedAt     DateTime?
  processedBy     String?
  
  // Data Export
  dataExportUrl   String?
  dataExportExpiry DateTime?
  
  // Deletion
  deletionCompletedAt DateTime?
  dataRetained    Json? // What data was retained and why
  
  notes           String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  auditTrail      GDPRDataRequestAudit[]
  
  @@index([workspaceId])
  @@index([requesterEmail])
  @@index([status])
  @@map("gdpr_data_requests")
}

enum GDPRRequestType {
  ACCESS // Right to access
  RECTIFICATION // Right to rectification
  ERASURE // Right to be forgotten
  PORTABILITY // Right to data portability
  RESTRICTION // Right to restrict processing
  OBJECTION // Right to object
}

enum GDPRRequestStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  REJECTED
  CANCELLED
}

model GDPRDataRequestAudit {
  id String @id @default(uuid())
  
  requestId String
  request   GDPRDataRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)
  
  action      String
  performedBy String?
  timestamp   DateTime @default(now())
  details     Json?
  
  @@index([requestId])
  @@index([timestamp])
  @@map("gdpr_data_request_audit")
}

model ComplianceReport {
  id String @id @default(uuid())
  
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  
  reportType      ComplianceReportType
  period          String // e.g., "2024-Q1"
  
  // Metrics
  totalDataSubjects       Int @default(0)
  activeConsents          Int @default(0)
  revokedConsents         Int @default(0)
  dataRequests            Int @default(0)
  dataRequestsCompleted   Int @default(0)
  averageResponseTime     Float? // hours
  
  // Compliance Score
  complianceScore         Float @default(0) // 0-100
  
  // Report Content
  summary                 String?
  findings                Json?
  recommendations         Json?
  
  // Generation
  generatedAt             DateTime @default(now())
  generatedBy             String?
  
  reportUrl               String?
  
  @@index([workspaceId])
  @@index([reportType])
  @@index([generatedAt])
  @@map("compliance_reports")
}

enum ComplianceReportType {
  MONTHLY
  QUARTERLY
  ANNUAL
  AD_HOC
}
