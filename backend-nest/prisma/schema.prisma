// Prisma Schema for Portal - Multi-Tenant B2B SaaS
// Database: PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ========================================
// AUTHENTICATION & USER MANAGEMENT
// ========================================

model User {
  id        String  @id @default(uuid())
  email     String  @unique
  password  String? // Nullable for OAuth-only users
  firstName String?
  lastName  String?
  name      String? // Full name for analytics
  avatar    String?
  phone     String? // Phone number for SMS notifications

  // OAuth providers
  googleId    String? @unique
  githubId    String? @unique
  firebaseUid String? @unique

  // Email verification
  emailVerified      Boolean   @default(false)
  emailVerifyToken   String?   @unique
  emailVerifyExpiry  DateTime?

  // Password reset
  resetToken       String?   @unique
  resetTokenExpiry DateTime?

  // Security
  twoFactorEnabled  Boolean  @default(false)
  twoFactorSecret   String?
  passwordChangedAt DateTime?
  failedLoginCount  Int      @default(0)
  lockedUntil       DateTime?

  // Multi-tenant relationship
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  // Roles & Permissions
  role WorkspaceRole @default(MEMBER)

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  lastLoginAt DateTime?

  // Relations
  createdPortals     Portal[]
  shareLinks         ShareLink[]
  alerts             Alert[]
  scheduledReports   ScheduledReport[]
  webhooks           Webhook[]
  comments           Comment[]
  workspaceMembers   WorkspaceMember[]
  sessions           UserSession[]
  auditLogs          AuditLog[]       @relation("UserAuditLogs")
  apiKeys            ApiKey[]
  aiQueries          AIQuery[]
  aiConversations    AIConversation[]
  pushTokens         PushToken[]
  gamificationProfile GamificationProfile?

  @@index([workspaceId])
  @@index([email])
  @@index([googleId])
  @@index([githubId])
  @@index([firebaseUid])
  @@map("users")
}

// Push notification tokens for users
model PushToken {
  id        String   @id @default(uuid())
  token     String   @unique
  platform  String   // 'ios', 'android', 'web'
  deviceId  String?  // Optional device identifier
  isActive  Boolean  @default(true)
  
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@map("push_tokens")
}

enum WorkspaceRole {
  OWNER
  ADMIN
  MEMBER
}

// ========================================
// WORKSPACE (TENANT)
// ========================================

model Workspace {
  id   String @id @default(uuid())
  name String
  slug String @unique // URL-friendly name

  // Branding
  logo         String? // S3/R2 URL
  primaryColor String  @default("#3B82F6") // Hex color

  // Contact & Metadata
  contactEmail String?
  website      String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  users                 User[]
  portals               Portal[]
  integrations          Integration[]
  subscription          Subscription?
  alerts                Alert[]
  scheduledReports      ScheduledReport[]
  webhooks              Webhook[]
  aiInsights            AIInsight[]
  aiConversations       AIConversation[]
  members               WorkspaceMember[]
  dataSourceHealth      DataSourceHealth[]
  dataValidationRules   DataValidationRule[]
  projects              Project[]
  clientReports         ClientReport[]
  gdprConsents          GDPRConsent[]
  gdprDataRequests      GDPRDataRequest[]
  complianceReports     ComplianceReport[]
  industryDeployments   IndustryDeployment[]
  aiModels              AIModel[]
  aiPredictions         AIPrediction[]
  aiQueries             AIQuery[]
  apiConnectors         APIConnector[]
  apiConnectorInstallations APIConnectorInstallation[]
  apiConnectorReviews   APIConnectorReview[]
  arScenes              ARScene[]
  workflows             Workflow[]
  complianceAssessments ComplianceAssessment[]
  dataMappings          DataMapping[]
  securityIncidents     SecurityIncident[]
  iotDevices            IoTDevice[]
  edgeNodes             EdgeNode[]
  etlPipelines          ETLPipeline[]

  @@map("workspaces")
}

// ========================================
// SUBSCRIPTION & BILLING
// ========================================

model Subscription {
  id String @id @default(uuid())

  // Workspace relationship
  workspaceId String    @unique
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  // Stripe
  stripeCustomerId       String    @unique
  stripeSubscriptionId   String?   @unique
  stripePriceId          String?
  stripeCurrentPeriodEnd DateTime?
  currentPeriodStart     DateTime?

  // Plan details
  plan   SubscriptionPlan   @default(TRIAL)
  status SubscriptionStatus @default(TRIALING)

  // Limits
  maxPortals Int @default(5)
  maxUsers   Int @default(1)

  // Trial
  trialEndsAt DateTime?

  // Timestamps
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  canceledAt DateTime?

  @@index([workspaceId])
  @@index([stripeCustomerId])
  @@map("subscriptions")
}

enum SubscriptionPlan {
  TRIAL
  PRO // $49/mo - 5 portals, 1 user
  AGENCY // $99/mo - 15 portals, 5 users
}

enum SubscriptionStatus {
  TRIALING
  ACTIVE
  PAST_DUE
  CANCELED
  CANCELLED
  INCOMPLETE
  INCOMPLETE_EXPIRED
  UNPAID
}

// ========================================
// INTEGRATIONS (OAuth Connections)
// ========================================

model Integration {
  id String @id @default(uuid())

  // Workspace relationship
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  // Provider details
  provider IntegrationProvider

  // OAuth tokens (ENCRYPTED in application layer)
  accessToken  String    @db.Text
  refreshToken String?   @db.Text
  expiresAt    DateTime?

  // Provider-specific metadata
  accountId   String? // e.g., Asana workspace GID, GA property ID
  accountName String? // Display name
  scopes      String? // Granted OAuth scopes

  // Settings (JSON for provider-specific config)
  settings Json @default("{}")

  // Status
  status        IntegrationStatus @default(ACTIVE)
  lastSyncedAt  DateTime?
  lastSyncError String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  widgets              Widget[]
  dataSourceHealth     DataSourceHealth?
  dataValidationRules  DataValidationRule[]
  rateLimitConfig      RateLimitConfig?
  rateLimitMetrics     RateLimitMetric[]

  @@unique([workspaceId, provider])
  @@index([workspaceId])
  @@index([status])
  @@map("integrations")
}

enum IntegrationProvider {
  // Original Integrations
  ASANA
  CLICKUP
  TRELLO
  GOOGLE_ANALYTICS
  GOOGLE_ANALYTICS_4
  HARVEST
  TOGGL
  GITHUB
  JIRA
  HUBSPOT
  SLACK
  MONDAY
  NOTION
  STRIPE

  // E-commerce Integrations
  SHOPIFY
  WOOCOMMERCE
  BIGCOMMERCE
  STRIPE_CONNECT
  SQUARE
  PAYPAL

  // Marketing Integrations
  FACEBOOK_ADS
  GOOGLE_ADS
  LINKEDIN_ADS
  TIKTOK_ADS
  TWITTER_ADS
  PINTEREST_ADS
  MAILCHIMP
  SENDGRID
  KLAVIYO

  // CRM Integrations
  SALESFORCE
  PIPEDRIVE
  ZOHO_CRM
  FRESHSALES
  COPPER
  CLOSE_CRM

  // Support Integrations
  ZENDESK
  INTERCOM
  FRESHDESK
  HELPSCOUT
  DRIFT
  CRISP
  FRONT

  // Database Integrations
  MONGODB_ATLAS
  POSTGRESQL_DIRECT
  MYSQL_DIRECT
  REDIS_CLOUD
  ELASTICSEARCH
  DYNAMODB
  FIREBASE_REALTIME
  SUPABASE

  // Cloud Monitoring Integrations
  AWS_CLOUDWATCH
  GCP_MONITORING
  AZURE_MONITOR
  AWS_S3
  AZURE_BLOB
  GCS_STORAGE

  // DevOps Integrations
  DATADOG
  NEW_RELIC
  SENTRY
  PAGERDUTY
  SPLUNK
  GRAFANA
  PROMETHEUS
  OPSGENIE

  // Data Warehouse Integrations
  SNOWFLAKE
  BIGQUERY
  REDSHIFT
  DATABRICKS
  DATALAKE_S3
  AZURE_SYNAPSE

  // IoT & Streaming
  AWS_IOT
  AZURE_IOT
  KAFKA
  MQTT_BROKER
  NATS

  // Productivity
  AIRTABLE
  CODA
  BASECAMP
  LINEAR
  FIGMA
  MIRO
}

enum IntegrationStatus {
  ACTIVE
  INACTIVE
  ERROR
  EXPIRED
}

// ========================================
// PORTALS (The Core Product)
// ========================================

model Portal {
  id String @id @default(uuid())

  // Workspace relationship
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  // Portal details
  name        String
  slug        String // Unique per workspace - used in public URL
  description String?

  // Public sharing
  isPublic   Boolean @default(true)
  shareToken String  @unique @default(uuid()) // Used in public URL: portal.to/v/{shareToken}

  // Layout configuration (JSON)
  layout Json @default("[]") // Array of widget positions/sizes for react-grid-layout

  // Creator
  createdById String
  createdBy   User   @relation(fields: [createdById], references: [id], onDelete: Cascade)

  // Cache settings
  cacheRefreshInterval Int       @default(30) // Minutes
  lastCachedAt         DateTime?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  widgets          Widget[]
  shareLinks       ShareLink[]
  scheduledReports ScheduledReport[]
  aiInsights       AIInsight[]
  aiConversations  AIConversation[]
  industryDeployment IndustryDeployment?
  aiPredictions    AIPrediction[]
  aiQueries        AIQuery[]
  arScenes         ARScene[]

  @@unique([workspaceId, slug])
  @@index([workspaceId])
  @@index([shareToken])
  @@map("portals")
}

// ========================================
// WIDGETS (Portal Building Blocks)
// ========================================

model Widget {
  id String @id @default(uuid())

  // Portal relationship
  portalId String
  portal   Portal @relation(fields: [portalId], references: [id], onDelete: Cascade)

  // Widget details
  name String

  // Widget type
  type WidgetType

  // Configuration (JSON - varies by widget type)
  config Json @default("{}")
  // Examples:
  // Text: { content: "...", format: "markdown" }
  // Asana Task List: { projectId: "...", filter: "in_progress" }
  // GA Metric: { metric: "users", period: "30d" }

  // Grid position (redundant with portal.layout, but useful for queries)
  gridX      Int @default(0)
  gridY      Int @default(0)
  gridWidth  Int @default(4)
  gridHeight Int @default(4)

  // Refresh settings
  refreshInterval Int       @default(300) // Seconds
  lastRefreshedAt DateTime?

  // Integration relationship (optional)
  integrationId String?
  integration   Integration? @relation(fields: [integrationId], references: [id], onDelete: SetNull)

  // Display order
  order Int @default(0)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  aiPredictions AIPrediction[]

  @@index([portalId])
  @@index([integrationId])
  @@map("widgets")
}

enum WidgetType {
  // Static widgets
  TEXT_BLOCK
  IMAGE
  VIDEO_EMBED

  // Asana widgets
  ASANA_TASK_LIST
  ASANA_PROJECT_PROGRESS

  // ClickUp widgets
  CLICKUP_TASK_LIST
  CLICKUP_PROJECT_PROGRESS

  // Trello widgets
  TRELLO_CARD_LIST
  TRELLO_BOARD_PROGRESS

  // Google Analytics 4 widgets
  GA4_METRIC_KPI
  GA4_LINE_GRAPH
  GA4_TOP_PAGES

  // Harvest widgets
  HARVEST_BUDGET_TRACKER
  HARVEST_TOTAL_HOURS

  // Toggl widgets
  TOGGL_TOTAL_HOURS
}

// ========================================
// CACHE STORAGE (For fast public portal loads)
// ========================================
// Note: Actual cache data stored in Redis
// This table stores metadata about cache jobs

model CacheJob {
  id String @id @default(uuid())

  // Portal reference
  portalId String

  // Job status
  status CacheJobStatus @default(PENDING)

  // Error tracking
  error      String?
  retryCount Int     @default(0)
  maxRetries Int     @default(3)

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  startedAt   DateTime?
  completedAt DateTime?
  failedAt    DateTime?

  @@index([portalId])
  @@index([status])
  @@map("cache_jobs")
}

enum CacheJobStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
}

// ========================================
// AUDIT LOGS (Enterprise Security Feature)
// ========================================

model AuditLog {
  id String @id @default(uuid())

  // Workspace & User tracking
  workspaceId String
  userId      String?
  userEmail   String
  user        User?         @relation("UserAuditLogs", fields: [userId], references: [id])

  // Action details
  action   AuditAction
  entity   String // e.g., "Portal", "Widget", "User"
  entityId String // ID of the affected resource

  // Request metadata
  ipAddress String?
  userAgent String?
  method    String // HTTP method: GET, POST, PUT, DELETE
  endpoint  String // API endpoint called

  // Changes tracking (JSON)
  oldValues Json? // Previous state
  newValues Json? // New state

  // Additional metadata
  metadata Json? // Any extra context

  // Status
  success      Boolean @default(true)
  errorMessage String?

  // Timestamp
  createdAt DateTime @default(now())

  @@index([workspaceId])
  @@index([userId])
  @@index([action])
  @@index([entity])
  @@index([createdAt])
  @@map("audit_logs")
}

enum AuditAction {
  // Authentication
  LOGIN
  LOGOUT
  PASSWORD_RESET

  // CRUD operations
  CREATE
  READ
  UPDATE
  DELETE

  // API Keys
  API_KEY_CREATED
  API_KEY_DELETED
  API_KEY_REGENERATED

  // Specific actions
  INVITE_USER
  REMOVE_USER
  UPLOAD_FILE
  EXPORT_DATA
  CHANGE_SETTINGS
  CONNECT_INTEGRATION
  DISCONNECT_INTEGRATION
}

// ========================================
// ANALYTICS & TRACKING
// ========================================

model AnalyticsEvent {
  id String @id @default(uuid())

  // Workspace & Portal tracking
  workspaceId String
  portalId    String?
  widgetId    String?

  // User tracking
  userId    String?
  sessionId String // Browser session ID

  // Event details
  eventType String // e.g., "portal_view", "widget_click", "widget_view"
  eventData Json? // Additional event-specific data

  // Request metadata
  ipAddress String?
  userAgent String?
  referrer  String? // Where the user came from

  // Timestamp
  timestamp DateTime @default(now())

  @@index([workspaceId])
  @@index([portalId])
  @@index([widgetId])
  @@index([eventType])
  @@index([timestamp])
  @@index([sessionId])
  @@map("analytics_events")
}

// ========================================
// WORKSPACE MEMBERS (Enhanced RBAC)
// ========================================

model WorkspaceMember {
  id String @id @default(uuid())

  // Relationships
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Role & Permissions
  role WorkspaceMemberRole @default(VIEWER)

  // Invitation tracking
  invitedBy  String?
  invitedAt  DateTime  @default(now())
  acceptedAt DateTime?

  // Status
  status MemberStatus @default(PENDING)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([workspaceId, userId])
  @@index([workspaceId])
  @@index([userId])
  @@map("workspace_members")
}

enum WorkspaceMemberRole {
  OWNER
  ADMIN
  EDITOR
  VIEWER
}

enum MemberStatus {
  PENDING
  ACTIVE
  SUSPENDED
}

// ========================================
// BACKGROUND JOBS METADATA
// ========================================

model JobMetadata {
  id String @id @default(uuid())

  // Job details
  jobId     String @unique // BullMQ job ID
  queueName String // Which queue: email, report, data-sync
  jobType   String // Specific job type

  // Workspace tracking
  workspaceId String
  userId      String?

  // Status
  status   JobStatus @default(QUEUED)
  progress Int       @default(0) // 0-100

  // Timing
  queuedAt    DateTime  @default(now())
  startedAt   DateTime?
  completedAt DateTime?
  failedAt    DateTime?

  // Results
  result Json? // Job result data
  error  String? // Error message if failed

  // Metadata
  metadata Json? // Additional context

  @@index([workspaceId])
  @@index([userId])
  @@index([status])
  @@index([queueName])
  @@map("job_metadata")
}

enum JobStatus {
  QUEUED
  ACTIVE
  COMPLETED
  FAILED
  DELAYED
  PAUSED
}

// ========================================
// NOTIFICATIONS
// ========================================

model Notification {
  id String @id @default(uuid())

  // Recipient
  userId      String
  workspaceId String

  // Notification details
  title   String
  message String
  type    NotificationType

  // Action link
  actionUrl String?

  // Status
  read   Boolean   @default(false)
  readAt DateTime?

  // Related entities
  portalId String?
  widgetId String?

  // Metadata
  metadata Json?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([workspaceId])
  @@index([read])
  @@index([createdAt])
  @@map("notifications")
}

enum NotificationType {
  INFO
  SUCCESS
  WARNING
  ERROR
  PORTAL_CREATED
  PORTAL_UPDATED
  PORTAL_DELETED
  WIDGET_ADDED
  WIDGET_UPDATED
  MEMBER_INVITED
  INTEGRATION_SYNCED
  INTEGRATION_FAILED
  ALERT_TRIGGERED
  REPORT_GENERATED
}

// ========================================
// PUBLIC SHARE LINKS
// ========================================

model ShareLink {
  id String @id @default(uuid())

  // Portal reference
  portalId String
  portal   Portal @relation(fields: [portalId], references: [id], onDelete: Cascade)

  // Share token (URL-friendly)
  token String @unique @default(uuid())

  // Access control
  password     String? // Hashed password for protected links
  expiresAt    DateTime?
  maxViews     Int? // Limit number of views
  currentViews Int       @default(0)

  // Permissions
  allowExport   Boolean @default(false) // Allow export from shared link
  allowComments Boolean @default(false)

  // Creator
  createdById String
  createdBy   User   @relation(fields: [createdById], references: [id], onDelete: Cascade)

  // Status
  isActive Boolean @default(true)

  // Analytics
  lastAccessedAt DateTime?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([portalId])
  @@index([token])
  @@index([isActive])
  @@map("share_links")
}

// ========================================
// ALERTS & MONITORING
// ========================================

model Alert {
  id String @id @default(uuid())

  // Workspace & Portal
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  portalId    String?
  widgetId    String?

  // Alert configuration
  name        String
  description String?
  condition   Json // {metric: "value", operator: ">", threshold: 100}
  severity    AlertSeverity @default(MEDIUM)
  
  // Notification channels
  channels Json // ["email", "slack", "webhook"]
  
  // Email settings
  emailRecipients String[] // List of emails
  
  // Webhook settings
  webhookUrl String?
  
  // Slack settings
  slackWebhook String?
  slackChannel String?

  // Status
  isActive Boolean @default(true)
  
  // Tracking
  lastTriggeredAt DateTime?
  triggerCount    Int       @default(0)

  // Creator
  createdById String
  createdBy   User   @relation(fields: [createdById], references: [id], onDelete: Cascade)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  history AlertHistory[]

  @@index([workspaceId])
  @@index([portalId])
  @@index([isActive])
  @@map("alerts")
}

model AlertHistory {
  id String @id @default(uuid())

  // Alert reference
  alertId String
  alert   Alert  @relation(fields: [alertId], references: [id], onDelete: Cascade)

  // Trigger details
  triggeredValue Json // The actual value that triggered the alert
  condition      Json // Copy of condition at trigger time
  
  // Notification status
  notificationsSent Json // {email: true, slack: false, webhook: true}
  
  // Timestamp
  triggeredAt DateTime @default(now())

  @@index([alertId])
  @@index([triggeredAt])
  @@map("alert_history")
}

// ========================================
// SCHEDULED REPORTS
// ========================================

model ScheduledReport {
  id String @id @default(uuid())

  // Workspace & Portal
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  portalId    String
  portal      Portal    @relation(fields: [portalId], references: [id], onDelete: Cascade)

  // Report configuration
  name        String
  description String?
  format      ReportFormat @default(PDF)
  
  // Schedule (cron expression)
  schedule String // e.g., "0 9 * * 1" for every Monday at 9 AM
  timezone String @default("UTC")

  // Recipients
  recipients String[] // Email addresses
  
  // Template
  templateId String?
  customTemplate Json? // Custom report template configuration

  // Status
  isActive Boolean @default(true)
  
  // Tracking
  lastRunAt     DateTime?
  nextRunAt     DateTime?
  lastRunStatus ReportStatus?
  runCount      Int          @default(0)

  // Creator
  createdById String
  createdBy   User   @relation(fields: [createdById], references: [id], onDelete: Cascade)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  runs ReportRun[]

  @@index([workspaceId])
  @@index([portalId])
  @@index([isActive])
  @@index([nextRunAt])
  @@map("scheduled_reports")
}

model ReportRun {
  id String @id @default(uuid())

  // Report reference
  reportId String
  report   ScheduledReport @relation(fields: [reportId], references: [id], onDelete: Cascade)

  // Execution details
  status    ReportStatus @default(PENDING)
  startedAt DateTime?
  completedAt DateTime?
  
  // Output
  fileUrl String? // S3/R2 URL if stored
  fileSize Int? // Bytes
  
  // Error tracking
  error String?
  
  // Metadata
  recipientsSent String[] // Successfully sent to these emails
  metadata       Json?

  // Timestamp
  createdAt DateTime @default(now())

  @@index([reportId])
  @@index([status])
  @@index([createdAt])
  @@map("report_runs")
}

enum ReportFormat {
  PDF
  CSV
  EXCEL
  JSON
}

enum ReportStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
  PARTIALLY_SENT
}

// ========================================
// WEBHOOKS
// ========================================

model Webhook {
  id String @id @default(uuid())

  // Workspace
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  // Webhook configuration
  name        String
  url         String
  secret      String? // For signature verification
  events      String[] // List of events to subscribe to
  
  // Headers
  headers Json? // Custom headers to send
  
  // Retry configuration
  maxRetries     Int @default(3)
  retryDelay     Int @default(60) // Seconds
  timeoutSeconds Int @default(30)

  // Status
  isActive Boolean @default(true)
  
  // Tracking
  lastTriggeredAt DateTime?
  successCount    Int       @default(0)
  failureCount    Int       @default(0)

  // Creator
  createdById String
  createdBy   User   @relation(fields: [createdById], references: [id], onDelete: Cascade)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  deliveries WebhookDelivery[]

  @@index([workspaceId])
  @@index([isActive])
  @@map("webhooks")
}

model WebhookDelivery {
  id String @id @default(uuid())

  // Webhook reference
  webhookId String
  webhook   Webhook @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  // Event details
  event     String
  payload   Json
  
  // Delivery attempt
  attempts      Int       @default(0)
  lastAttemptAt DateTime?
  nextAttemptAt DateTime?
  
  // Response
  status         WebhookStatus @default(PENDING)
  responseCode   Int?
  responseBody   String?
  responseTime   Int? // Milliseconds
  
  // Error
  error String?

  // Timestamp
  createdAt DateTime @default(now())

  @@index([webhookId])
  @@index([status])
  @@index([event])
  @@index([nextAttemptAt])
  @@map("webhook_deliveries")
}

enum WebhookStatus {
  PENDING
  SUCCESS
  FAILED
  RETRYING
}

// ========================================
// COMMENTS & COLLABORATION
// ========================================

model Comment {
  id String @id @default(uuid())

  // Location
  portalId String
  widgetId String?
  
  // Annotation Positioning (Phase 3)
  positionX Float? // Percentage (0-100)
  positionY Float? // Percentage (0-100)
  dataPoint Json?  // Linked data point context

  // Author
  authorId String
  author   User   @relation(fields: [authorId], references: [id], onDelete: Cascade)

  // Content
  content  String   @db.Text
  type     CommentType @default(COMMENT) // COMMENT, PIN, FLAG, etc.
  mentions String[] // User IDs mentioned in comment
  
  // Thread
  parentId String?
  parent   Comment?  @relation("CommentThread", fields: [parentId], references: [id], onDelete: Cascade)
  replies  Comment[] @relation("CommentThread")
  
  // Status
  isEdited  Boolean   @default(false)
  isDeleted Boolean   @default(false)
  resolved  Boolean   @default(false)
  editedAt  DateTime?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([portalId])
  @@index([widgetId])
  @@index([authorId])
  @@index([parentId])
  @@map("comments")
}

enum CommentType {
  COMMENT
  PIN
  FLAG
  ALERT
  SUCCESS
  INFO
}

// ========================================
// AI INSIGHTS
// ========================================

model AIInsight {
  id String @id @default(uuid())

  // Workspace & Portal
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  portalId    String
  portal      Portal    @relation(fields: [portalId], references: [id], onDelete: Cascade)

  // Insight details
  type        InsightType
  title       String
  description String      @db.Text
  severity    InsightSeverity @default(INFO)
  confidence  Float // 0.0 to 1.0
  
  // Data
  data Json // Supporting data for the insight
  
  // Recommendations
  recommendations Json? // Suggested actions
  
  // Status
  status     InsightStatus @default(NEW)
  dismissedBy String?
  dismissedAt DateTime?
  
  // Quality tracking (feedback loop)
  qualityScore  Float? // 0.0 to 1.0 based on user feedback
  feedbackCount Int @default(0)
  
  // Validity
  validFrom DateTime @default(now())
  validUntil DateTime?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  feedback AIFeedback[]

  @@index([workspaceId])
  @@index([portalId])
  @@index([type])
  @@index([status])
  @@index([qualityScore])
  @@map("ai_insights")
}

// User feedback on AI insights for continuous improvement
model AIFeedback {
  id String @id @default(uuid())

  // Insight reference
  insightId String
  insight   AIInsight @relation(fields: [insightId], references: [id], onDelete: Cascade)

  // User who provided feedback
  userId String

  // Feedback details
  rating      String // 'helpful', 'not_helpful', 'neutral'
  comment     String? @db.Text
  actionTaken String? // What action user took based on insight

  // Timestamps
  createdAt DateTime @default(now())

  @@index([insightId])
  @@index([userId])
  @@index([rating])
  @@map("ai_feedback")
}

// AI Conversation history for conversational AI assistant
model AIConversation {
  id String @id @default(uuid())

  // Workspace & User
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Optional portal context
  portalId String?
  portal   Portal? @relation(fields: [portalId], references: [id], onDelete: SetNull)

  // Conversation data
  query       String   @db.Text
  response    Json
  queryType   String?
  success     Boolean  @default(true)
  
  // Metadata
  processingTime Int?     // milliseconds
  tokenCount     Int?
  modelUsed      String?
  
  // Timestamps
  createdAt DateTime @default(now())

  @@index([workspaceId])
  @@index([userId])
  @@index([portalId])
  @@index([createdAt])
  @@map("ai_conversations")
}

enum InsightType {
  ANOMALY
  TREND
  PREDICTION
  RECOMMENDATION
  SUMMARY
}

enum InsightSeverity {
  INFO
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum InsightStatus {
  NEW
  VIEWED
  ACTIONED
  DISMISSED
}

// ========================================
// WIDGET TEMPLATES
// ========================================

model WidgetTemplate {
  id String @id @default(uuid())

  // Template details
  name        String
  description String?
  category    TemplateCategory
  thumbnail   String? // Preview image URL

  // Template configuration
  widgetType WidgetType
  config     Json // Default widget configuration
  layout     Json? // Default grid layout settings

  // Visibility
  isPublic    Boolean @default(false) // Available to all users
  workspaceId String? // Null if public template
  
  // Creator (null for system templates)
  createdById String?
  
  // Usage tracking
  usageCount Int @default(0)

  // Tags for filtering
  tags String[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category])
  @@index([widgetType])
  @@index([isPublic])
  @@index([workspaceId])
  @@map("widget_templates")
}

enum TemplateCategory {
  PROJECT_MANAGEMENT
  ANALYTICS
  TIME_TRACKING
  MARKETING
  SALES
  DEVELOPMENT
  CUSTOM
}

// ========================================
// BILLING & USAGE
// ========================================

model BillingEvent {
  id String @id @default(uuid())

  // Workspace
  workspaceId String
  
  // Stripe references
  stripeEventId      String? @unique
  stripeInvoiceId    String?
  stripePaymentIntentId String?
  
  // Event details
  type        BillingEventType
  amount      Int? // In cents
  currency    String @default("usd")
  description String?
  
  // Status
  status BillingEventStatus @default(PENDING)
  
  // Metadata
  metadata Json?

  // Timestamp
  createdAt DateTime @default(now())

  @@index([workspaceId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
  @@map("billing_events")
}

enum BillingEventType {
  SUBSCRIPTION_CREATED
  SUBSCRIPTION_UPDATED
  SUBSCRIPTION_CANCELED
  INVOICE_PAID
  INVOICE_FAILED
  PAYMENT_SUCCEEDED
  PAYMENT_FAILED
  TRIAL_ENDED
  PLAN_UPGRADED
  PLAN_DOWNGRADED
}

enum BillingEventStatus {
  PENDING
  COMPLETED
  FAILED
}

model UsageMetric {
  id String @id @default(uuid())

  // Workspace
  workspaceId String
  
  // Metric details
  metricType  UsageMetricType
  value       Float
  unit        String? // e.g., "count", "bytes", "ms"
  
  // Resource references
  portalId String?
  widgetId String?
  userId   String?
  
  // Time bucket
  period     DateTime // Rounded to hour/day for aggregation
  periodType PeriodType @default(HOURLY)
  
  // Metadata
  metadata Json?

  // Timestamp
  createdAt DateTime @default(now())

  @@index([workspaceId])
  @@index([metricType])
  @@index([period])
  @@index([portalId])
  @@map("usage_metrics")
}

enum UsageMetricType {
  PORTAL_VIEWS
  WIDGET_LOADS
  API_CALLS
  EXPORT_COUNT
  STORAGE_BYTES
  INTEGRATION_SYNCS
  REPORT_GENERATIONS
  AI_INSIGHTS_GENERATED
  BANDWIDTH_BYTES
  ACTIVE_USERS
}

enum PeriodType {
  HOURLY
  DAILY
  WEEKLY
  MONTHLY
}

// ========================================
// PORTAL TEMPLATES (Full Dashboard)
// ========================================

model PortalTemplate {
  id String @id @default(uuid())

  // Template details
  name        String
  description String?
  category    TemplateCategory
  thumbnail   String? // Preview image URL

  // Template configuration
  layout        Json // Widget layout configuration
  widgetConfigs Json // Array of widget configurations
  settings      Json? // Portal-level settings

  // Visibility
  isPublic    Boolean @default(false)
  workspaceId String? // Null if public template
  
  // Creator (null for system templates)
  createdById String?
  
  // Usage tracking
  usageCount Int @default(0)

  // Tags for filtering
  tags String[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category])
  @@index([isPublic])
  @@index([workspaceId])
  @@map("portal_templates")
}

enum AlertSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

// ========================================
// SECURITY MODELS
// ========================================

model UserSession {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Session details
  token        String   @unique
  refreshToken String?  @unique
  
  // Device/Client info
  ipAddress  String
  userAgent  String
  deviceType String?
  location   String?
  
  // Status
  isActive   Boolean  @default(true)
  lastActive DateTime @default(now())
  expiresAt  DateTime
  
  // Timestamps
  createdAt DateTime @default(now())
  
  @@index([userId])
  @@index([token])
  @@index([isActive])
  @@map("user_sessions")
}

model ApiKey {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspaceId String
  
  // Key details
  name        String
  keyHash     String   @unique
  keyPrefix   String   // First 8 chars for identification
  
  // Permissions
  scopes      String[]
  
  // Rate limiting
  rateLimit   Int      @default(1000)
  
  // Status
  isActive    Boolean  @default(true)
  lastUsedAt  DateTime?
  expiresAt   DateTime?
  
  // Timestamps
  createdAt   DateTime @default(now())
  revokedAt   DateTime?
  
  @@index([workspaceId])
  @@index([keyHash])
  @@index([isActive])
  @@map("api_keys")
}

model SecurityEvent {
  id        String   @id @default(uuid())
  
  // Event details
  eventType   String    // login_failed, suspicious_activity, etc.
  severity    String    // low, medium, high, critical
  
  // Actor
  userId      String?
  ipAddress   String
  userAgent   String?
  
  // Context
  resourceType String?
  resourceId   String?
  workspaceId  String?
  
  // Details
  description String
  metadata    Json?
  
  // Resolution
  resolved    Boolean   @default(false)
  resolvedAt  DateTime?
  resolvedBy  String?
  
  // Timestamps
  createdAt   DateTime  @default(now())
  
  @@index([eventType])
  @@index([severity])
  @@index([userId])
  @@index([ipAddress])
  @@index([createdAt])
  @@map("security_events")
}

model IpBlocklist {
  id        String   @id @default(uuid())
  
  ipAddress   String   @unique
  reason      String
  blockedBy   String?
  expiresAt   DateTime?
  
  createdAt   DateTime @default(now())
  
  @@index([ipAddress])
  @@index([expiresAt])
  @@map("ip_blocklist")
}

// ========================================
// SYSTEM METRICS & ANALYTICS
// ========================================

model SystemMetrics {
  id String @id @default(uuid())
  
  metricType String
  value      Float
  unit       String?
  timestamp  DateTime @default(now())
  metadata   Json?
  
  @@index([metricType])
  @@index([timestamp])
  @@map("system_metrics")
}

model RevenueMetrics {
  id String @id @default(uuid())
  
  metricType String
  value      Float
  currency   String @default("usd")
  timestamp  DateTime @default(now())
  metadata   Json?
  
  @@index([metricType])
  @@index([timestamp])
  @@map("revenue_metrics")
}

model UserActivityMetrics {
  id String @id @default(uuid())
  
  metricType String
  value      Float
  timestamp  DateTime @default(now())
  metadata   Json?
  
  @@index([metricType])
  @@index([timestamp])
  @@map("user_activity_metrics")
}

// ========================================
// DATA QUALITY & RELIABILITY FEATURES
// ========================================

model DataSourceHealth {
  id String @id @default(uuid())
  
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  
  integrationId String
  integration   Integration @relation(fields: [integrationId], references: [id], onDelete: Cascade)
  
  // Health Status
  status            HealthStatus @default(HEALTHY)
  lastCheckAt       DateTime @default(now())
  lastSuccessAt     DateTime?
  lastErrorAt       DateTime?
  consecutiveErrors Int @default(0)
  
  // Performance Metrics
  responseTime      Float? // milliseconds
  dataFreshness     Int? // minutes since last data update
  freshnessThreshold Int @default(60) // alert if data older than this
  
  // Error Tracking
  lastError         String?
  errorCount        Int @default(0)
  rateLimit         Boolean @default(false)
  rateLimitResetAt  DateTime?
  
  // Schema Tracking
  lastKnownSchema   Json? // Store data structure
  schemaChangedAt   DateTime?
  schemaChangeDetected Boolean @default(false)
  
  // Alerting
  alertsEnabled     Boolean @default(true)
  alertThreshold    Int @default(3) // consecutive errors before alert
  lastAlertSentAt   DateTime?
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  healthChecks      DataSourceHealthCheck[]
  
  @@unique([integrationId])
  @@index([workspaceId])
  @@index([status])
  @@index([lastCheckAt])
  @@map("data_source_health")
}

enum HealthStatus {
  HEALTHY
  DEGRADED
  DOWN
  RATE_LIMITED
  SCHEMA_CHANGED
}

model DataSourceHealthCheck {
  id String @id @default(uuid())
  
  dataSourceHealthId String
  dataSourceHealth   DataSourceHealth @relation(fields: [dataSourceHealthId], references: [id], onDelete: Cascade)
  
  timestamp         DateTime @default(now())
  status            HealthStatus
  responseTime      Float? // milliseconds
  errorMessage      String?
  dataFreshness     Int? // minutes
  recordsChecked    Int?
  
  metadata          Json?
  
  @@index([dataSourceHealthId])
  @@index([timestamp])
  @@map("data_source_health_checks")
}

model DataValidationRule {
  id String @id @default(uuid())
  
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  
  name            String
  description     String?
  enabled         Boolean @default(true)
  
  // Target
  integrationId   String?
  integration     Integration? @relation(fields: [integrationId], references: [id], onDelete: Cascade)
  dataSource      String? // Generic data source identifier
  fieldPath       String // JSON path to field to validate
  
  // Rule Type
  ruleType        ValidationRuleType
  
  // Rule Configuration
  config          Json // Rule-specific config (thresholds, allowed values, etc)
  
  // Severity
  severity        ValidationSeverity @default(WARNING)
  
  // Notifications
  notifyOnFailure Boolean @default(true)
  notifyEmails    String[] // Array of emails to notify
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  violations      DataValidationViolation[]
  
  @@index([workspaceId])
  @@index([enabled])
  @@map("data_validation_rules")
}

enum ValidationRuleType {
  NO_NEGATIVE_VALUES
  RANGE_CHECK
  SPIKE_DETECTION
  MISSING_FIELD
  REQUIRED_FIELD
  CROSS_SOURCE_CONSISTENCY
  CUSTOM_REGEX
  DATA_TYPE_CHECK
}

enum ValidationSeverity {
  INFO
  WARNING
  ERROR
  CRITICAL
}

model DataValidationViolation {
  id String @id @default(uuid())
  
  ruleId String
  rule   DataValidationRule @relation(fields: [ruleId], references: [id], onDelete: Cascade)
  
  timestamp       DateTime @default(now())
  fieldPath       String
  actualValue     String? // Stringified value
  expectedValue   String? // What was expected
  violationType   String
  severity        ValidationSeverity
  
  resolved        Boolean @default(false)
  resolvedAt      DateTime?
  resolvedBy      String?
  resolutionNotes String?
  
  metadata        Json?
  
  @@index([ruleId])
  @@index([timestamp])
  @@index([resolved])
  @@map("data_validation_violations")
}

// ========================================
// BUSINESS INTELLIGENCE FEATURES
// ========================================

model Project {
  id String @id @default(uuid())
  
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  
  name            String
  clientName      String
  description     String?
  
  // Financial
  budgetAmount    Float?
  hourlyRate      Float?
  currency        String @default("USD")
  
  // Status
  status          ProjectStatus @default(ACTIVE)
  startDate       DateTime?
  endDate         DateTime?
  
  // Tracking
  totalHours      Float @default(0)
  billableHours   Float @default(0)
  actualCosts     Float @default(0)
  
  metadata        Json?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  timeEntries     ProjectTimeEntry[]
  expenses        ProjectExpense[]
  profitability   ProjectProfitability?
  clientReports   ClientReport[]
  
  @@index([workspaceId])
  @@index([status])
  @@index([clientName])
  @@map("projects")
}

enum ProjectStatus {
  ACTIVE
  ON_HOLD
  COMPLETED
  CANCELLED
}

model ProjectTimeEntry {
  id String @id @default(uuid())
  
  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  userId      String
  description String?
  
  hours       Float
  billable    Boolean @default(true)
  hourlyRate  Float?
  
  date        DateTime
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([projectId])
  @@index([date])
  @@map("project_time_entries")
}

model ProjectExpense {
  id String @id @default(uuid())
  
  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  description String
  amount      Float
  category    String?
  billable    Boolean @default(true)
  
  date        DateTime
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([projectId])
  @@index([date])
  @@map("project_expenses")
}

model ProjectProfitability {
  id String @id @default(uuid())
  
  projectId String @unique
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  // Revenue
  totalRevenue      Float @default(0)
  billableRevenue   Float @default(0)
  
  // Costs
  laborCosts        Float @default(0)
  expenseCosts      Float @default(0)
  totalCosts        Float @default(0)
  
  // Profitability
  grossProfit       Float @default(0)
  profitMargin      Float @default(0) // Percentage
  
  // Efficiency
  utilizationRate   Float @default(0) // Percentage
  billableRatio     Float @default(0) // Percentage
  
  // Scoring
  profitabilityScore Float @default(0) // 0-100
  
  lastCalculatedAt  DateTime @default(now())
  
  @@index([profitabilityScore])
  @@map("project_profitability")
}

model ClientReport {
  id String @id @default(uuid())
  
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  
  projectId String?
  project   Project? @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  title           String
  clientName      String
  reportType      ReportType @default(WEEKLY)
  
  // Content
  executiveSummary String?
  keyInsights      Json? // Array of insight objects
  metrics          Json? // Key metrics data
  recommendations  Json? // Array of recommendations
  
  // Generation
  aiGenerated     Boolean @default(false)
  generatedBy     String?
  
  // Delivery
  status          ClientReportStatus @default(DRAFT)
  scheduledFor    DateTime?
  sentAt          DateTime?
  recipientEmails String[]
  
  // Attachments
  pdfUrl          String?
  presentationUrl String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([workspaceId])
  @@index([projectId])
  @@index([status])
  @@index([scheduledFor])
  @@map("client_reports")
}

enum ReportType {
  DAILY
  WEEKLY
  MONTHLY
  QUARTERLY
  MILESTONE
  CUSTOM
}

enum ClientReportStatus {
  DRAFT
  SCHEDULED
  GENERATING
  SENT
  FAILED
}

// ========================================
// GDPR COMPLIANCE & SECURITY
// ========================================

model GDPRConsent {
  id String @id @default(uuid())
  
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  
  userId      String?
  
  // Subject Info
  subjectEmail String
  subjectName  String?
  
  // Consent Details
  consentType     ConsentType
  purpose         String
  consented       Boolean @default(false)
  consentedAt     DateTime?
  
  // Tracking
  ipAddress       String?
  userAgent       String?
  
  // Revocation
  revokedAt       DateTime?
  revocationReason String?
  
  // Expiry
  expiresAt       DateTime?
  
  metadata        Json?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([workspaceId])
  @@index([subjectEmail])
  @@index([consentType])
  @@map("gdpr_consents")
}

enum ConsentType {
  DATA_PROCESSING
  MARKETING
  ANALYTICS
  THIRD_PARTY_SHARING
  PROFILING
}

model GDPRDataRequest {
  id String @id @default(uuid())
  
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  
  // Requester Info
  requesterEmail  String
  requesterName   String?
  
  // Request Details
  requestType     GDPRRequestType
  status          GDPRRequestStatus @default(PENDING)
  
  // Processing
  submittedAt     DateTime @default(now())
  processedAt     DateTime?
  processedBy     String?
  
  // Data Export
  dataExportUrl   String?
  dataExportExpiry DateTime?
  
  // Deletion
  deletionCompletedAt DateTime?
  dataRetained    Json? // What data was retained and why
  
  notes           String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  auditTrail      GDPRDataRequestAudit[]
  
  @@index([workspaceId])
  @@index([requesterEmail])
  @@index([status])
  @@map("gdpr_data_requests")
}

enum GDPRRequestType {
  ACCESS // Right to access
  RECTIFICATION // Right to rectification
  ERASURE // Right to be forgotten
  PORTABILITY // Right to data portability
  RESTRICTION // Right to restrict processing
  OBJECTION // Right to object
}

enum GDPRRequestStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  REJECTED
  CANCELLED
}

model GDPRDataRequestAudit {
  id String @id @default(uuid())
  
  requestId String
  request   GDPRDataRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)
  
  action      String
  performedBy String?
  timestamp   DateTime @default(now())
  details     Json?
  
  @@index([requestId])
  @@index([timestamp])
  @@map("gdpr_data_request_audit")
}

model ComplianceReport {
  id String @id @default(uuid())
  
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  
  reportType      ComplianceReportType
  period          String // e.g., "2024-Q1"
  
  // Metrics
  totalDataSubjects       Int @default(0)
  activeConsents          Int @default(0)
  revokedConsents         Int @default(0)
  dataRequests            Int @default(0)
  dataRequestsCompleted   Int @default(0)
  averageResponseTime     Float? // hours
  
  // Compliance Score
  complianceScore         Float @default(0) // 0-100
  
  // Report Content
  summary                 String?
  findings                Json?
  recommendations         Json?
  
  // Generation
  generatedAt             DateTime @default(now())
  generatedBy             String?
  
  reportUrl               String?
  
  @@index([workspaceId])
  @@index([reportType])
  @@index([generatedAt])
  @@map("compliance_reports")
}

enum ComplianceReportType {
  MONTHLY
  QUARTERLY
  ANNUAL
  AD_HOC
}

// ========================================
// INDUSTRY-SPECIFIC SOLUTIONS
// ========================================

model IndustryTemplate {
  id String @id @default(uuid())
  
  name        String
  description String?
  industry    IndustryType
  
  // Template Configuration
  config      Json // Includes widgets, layouts, metrics
  thumbnail   String?
  
  // Metadata
  isActive    Boolean @default(true)
  usageCount  Int     @default(0)
  rating      Float   @default(0)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  deployments IndustryDeployment[]
  
  @@index([industry])
  @@map("industry_templates")
}

enum IndustryType {
  HEALTHCARE
  FINANCE
  RETAIL
  MANUFACTURING
  EDUCATION
  REAL_ESTATE
  LOGISTICS
  HOSPITALITY
  TECHNOLOGY
  GOVERNMENT
}

model IndustryDeployment {
  id String @id @default(uuid())
  
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  
  templateId String
  template   IndustryTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  
  portalId String @unique
  portal   Portal @relation(fields: [portalId], references: [id], onDelete: Cascade)
  
  // Compliance tracking for healthcare, finance, etc.
  complianceStatus Json? // HIPAA, PCI-DSS, SOC2, etc.
  lastComplianceCheck DateTime?
  
  customizations Json? // User-specific overrides
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([workspaceId])
  @@index([templateId])
  @@map("industry_deployments")
}

// ========================================
// ADVANCED AI/ML CAPABILITIES
// ========================================

model AIModel {
  id String @id @default(uuid())
  
  name        String
  description String?
  modelType   AIModelType
  
  // Model Configuration
  provider    AIProvider
  modelId     String // e.g., "gpt-4", "claude-3"
  config      Json   // API keys, endpoints, parameters
  
  // Training Data
  trainingDataUrl String?
  version         String  @default("1.0.0")
  
  // Performance Metrics
  accuracy        Float?
  precision       Float?
  recall          Float?
  f1Score         Float?
  
  isActive        Boolean @default(true)
  isPublic        Boolean @default(false)
  
  workspaceId String?
  workspace   Workspace? @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  predictions AIPrediction[]
  queries     AIQuery[]
  
  @@index([workspaceId])
  @@index([modelType])
  @@map("ai_models")
}

enum AIModelType {
  FORECASTING
  CLASSIFICATION
  CLUSTERING
  ANOMALY_DETECTION
  NLP
  COMPUTER_VISION
  RECOMMENDATION
}

enum AIProvider {
  OPENAI
  ANTHROPIC
  GOOGLE
  CUSTOM
  HUGGINGFACE
}

model AIPrediction {
  id String @id @default(uuid())
  
  modelId String
  model   AIModel @relation(fields: [modelId], references: [id], onDelete: Cascade)
  
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  
  // Input/Output
  inputData   Json
  prediction  Json
  confidence  Float
  
  // Context
  widgetId    String?
  widget      Widget? @relation(fields: [widgetId], references: [id], onDelete: SetNull)
  
  portalId    String?
  portal      Portal? @relation(fields: [portalId], references: [id], onDelete: SetNull)
  
  // Metadata
  executionTime Int // milliseconds
  
  createdAt DateTime @default(now())
  
  @@index([modelId])
  @@index([workspaceId])
  @@index([widgetId])
  @@map("ai_predictions")
}

model AIQuery {
  id String @id @default(uuid())
  
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  modelId String?
  model   AIModel? @relation(fields: [modelId], references: [id], onDelete: SetNull)
  
  // Query
  query       String
  queryType   AIQueryType
  
  // Response
  response    Json
  sqlGenerated String?
  
  // Context
  portalId    String?
  portal      Portal? @relation(fields: [portalId], references: [id], onDelete: SetNull)
  
  createdAt DateTime @default(now())
  
  @@index([workspaceId])
  @@index([userId])
  @@map("ai_queries")
}

enum AIQueryType {
  NATURAL_LANGUAGE
  SQL_GENERATION
  DATA_ANALYSIS
  INSIGHT_GENERATION
}

// ========================================
// API MARKETPLACE & CUSTOM INTEGRATIONS
// ========================================

model APIConnector {
  id String @id @default(uuid())
  
  name        String
  description String?
  
  // Connector Details
  connectorType APIConnectorType
  category      String // e.g., "CRM", "Marketing", "Finance"
  
  // Technical Details
  authType      APIAuthType
  baseUrl       String?
  apiVersion    String?
  
  // Configuration Schema (JSON Schema)
  configSchema  Json
  
  // Icon & Branding
  iconUrl       String?
  logoUrl       String?
  
  // Publisher
  publisherId   String?
  publisherName String?
  
  workspaceId String? // If custom connector
  workspace   Workspace? @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  
  // Marketplace Metrics
  isPublic      Boolean @default(false)
  price         Float   @default(0) // Monthly price
  rating        Float   @default(0)
  downloads     Int     @default(0)
  usageCount    Int     @default(0)
  
  // Status
  isActive      Boolean @default(true)
  isVerified    Boolean @default(false)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  installations APIConnectorInstallation[]
  reviews       APIConnectorReview[]
  
  @@index([connectorType])
  @@index([category])
  @@index([isPublic])
  @@map("api_connectors")
}

enum APIConnectorType {
  REST
  GRAPHQL
  SOAP
  WEBHOOK
  WEBSOCKET
  DATABASE
  FILE
}

enum APIAuthType {
  API_KEY
  OAUTH2
  BASIC_AUTH
  BEARER_TOKEN
  JWT
  CUSTOM
}

model APIConnectorInstallation {
  id String @id @default(uuid())
  
  connectorId String
  connector   APIConnector @relation(fields: [connectorId], references: [id], onDelete: Cascade)
  
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  
  // Configuration
  config      Json // User-specific settings
  credentials Json // Encrypted credentials
  
  // Status
  isActive    Boolean @default(true)
  lastSyncAt  DateTime?
  syncStatus  String?
  
  installedAt DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  usageLogs   APIUsageLog[]
  
  @@unique([connectorId, workspaceId])
  @@index([workspaceId])
  @@map("api_connector_installations")
}

model APIConnectorReview {
  id String @id @default(uuid())
  
  connectorId String
  connector   APIConnector @relation(fields: [connectorId], references: [id], onDelete: Cascade)
  
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  
  userId String
  
  rating  Int // 1-5
  review  String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([connectorId, workspaceId])
  @@index([connectorId])
  @@map("api_connector_reviews")
}

model APIUsageLog {
  id String @id @default(uuid())
  
  installationId String
  installation   APIConnectorInstallation @relation(fields: [installationId], references: [id], onDelete: Cascade)
  
  // Request Details
  method      String
  endpoint    String
  statusCode  Int
  
  // Performance
  responseTime Int // milliseconds
  dataSize     Int // bytes
  
  // Error tracking
  errorMessage String?
  
  timestamp DateTime @default(now())
  
  @@index([installationId])
  @@index([timestamp])
  @@map("api_usage_logs")
}

// ========================================
// AR VISUALIZATION
// ========================================

model ARScene {
  id String @id @default(uuid())
  
  name        String
  description String?
  
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  
  portalId String?
  portal   Portal? @relation(fields: [portalId], references: [id], onDelete: SetNull)
  
  // Scene Configuration
  sceneData   Json // 3D models, positions, animations
  arMarkers   Json? // Marker-based AR configuration
  
  // Assets
  modelUrls   Json // Array of 3D model URLs
  textureUrls Json? // Array of texture URLs
  
  // Interaction
  interactions Json? // Touch, gesture, voice commands
  
  // Settings
  scale       Float @default(1.0)
  lighting    Json?
  
  isActive    Boolean @default(true)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  sessions    ARSession[]
  
  @@index([workspaceId])
  @@index([portalId])
  @@map("ar_scenes")
}

model ARSession {
  id String @id @default(uuid())
  
  sceneId String
  scene   ARScene @relation(fields: [sceneId], references: [id], onDelete: Cascade)
  
  userId      String
  deviceType  String // "mobile", "headset", "web"
  
  // Session Data
  duration    Int // seconds
  interactions Json? // User interactions during session
  
  // Performance
  fps         Float?
  latency     Int? // milliseconds
  
  startedAt DateTime @default(now())
  endedAt   DateTime?
  
  @@index([sceneId])
  @@index([userId])
  @@map("ar_sessions")
}

// ========================================
// WORKFLOW AUTOMATION
// ========================================

model Workflow {
  id String @id @default(uuid())
  
  name        String
  description String?
  
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  
  // Workflow Configuration
  trigger     Json // Event that starts workflow
  actions     Json // Array of actions to perform
  conditions  Json? // Conditional logic
  
  // Visual Editor Data
  nodes       Json // Flow diagram nodes
  edges       Json // Flow diagram connections
  
  // Status
  isActive    Boolean @default(true)
  version     Int     @default(1)
  
  // Execution Stats
  executionCount    Int @default(0)
  successCount      Int @default(0)
  failureCount      Int @default(0)
  lastExecutedAt    DateTime?
  averageExecutionTime Int? // milliseconds
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  executions WorkflowExecution[]
  
  @@index([workspaceId])
  @@index([isActive])
  @@map("workflows")
}

model WorkflowExecution {
  id String @id @default(uuid())
  
  workflowId String
  workflow   Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  
  // Trigger Data
  triggerData Json
  
  // Execution
  status      WorkflowExecutionStatus
  steps       Json // Array of step results
  
  // Performance
  startedAt   DateTime @default(now())
  completedAt DateTime?
  duration    Int? // milliseconds
  
  // Error Handling
  error       String?
  errorStep   String?
  retryCount  Int @default(0)
  
  @@index([workflowId])
  @@index([status])
  @@index([startedAt])
  @@map("workflow_executions")
}

enum WorkflowExecutionStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
}

model WorkflowTemplate {
  id String @id @default(uuid())
  
  name        String
  description String?
  category    String
  
  // Template Configuration
  template    Json
  thumbnail   String?
  
  // Marketplace
  isPublic    Boolean @default(false)
  rating      Float   @default(0)
  usageCount  Int     @default(0)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([category])
  @@index([isPublic])
  @@map("workflow_templates")
}

// ========================================
// ENHANCED COMPLIANCE & SECURITY
// ========================================

model ComplianceFramework {
  id String @id @default(uuid())
  
  name        String // "HIPAA", "PCI-DSS", "SOC2", "GDPR"
  description String?
  
  // Framework Requirements
  requirements Json // Array of requirements with IDs
  controls     Json // Array of control measures
  
  // Audit Configuration
  auditSchedule String? // Cron expression
  
  isActive Boolean @default(true)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  assessments ComplianceAssessment[]
  
  @@map("compliance_frameworks")
}

model ComplianceAssessment {
  id String @id @default(uuid())
  
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  
  frameworkId String
  framework   ComplianceFramework @relation(fields: [frameworkId], references: [id], onDelete: Cascade)
  
  // Assessment Results
  status      ComplianceStatus
  score       Float // 0-100
  
  findings    Json // Array of findings
  gaps        Json // Array of gaps
  recommendations Json // Array of recommendations
  
  // Remediation
  remediationPlan Json?
  remediationStatus String?
  
  assessedAt DateTime @default(now())
  assessedBy String?
  
  nextAssessmentDue DateTime?
  
  reportUrl   String?
  
  @@index([workspaceId])
  @@index([frameworkId])
  @@index([status])
  @@map("compliance_assessments")
}

enum ComplianceStatus {
  COMPLIANT
  PARTIALLY_COMPLIANT
  NON_COMPLIANT
  NOT_ASSESSED
}

model DataMapping {
  id String @id @default(uuid())
  
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  
  // Data Inventory
  dataType    String // "PII", "PHI", "Financial", etc.
  location    String // Database, service, file location
  fields      Json   // Array of field mappings
  
  // Classification
  sensitivity DataSensitivity
  category    String
  
  // Processing
  processingPurpose String
  legalBasis        String? // GDPR legal basis
  retentionPeriod   String? // "90 days", "7 years"
  
  // Protection
  encryptionMethod String?
  accessControls   Json?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([workspaceId])
  @@index([sensitivity])
  @@map("data_mappings")
}

enum DataSensitivity {
  PUBLIC
  INTERNAL
  CONFIDENTIAL
  RESTRICTED
}

model SecurityIncident {
  id String @id @default(uuid())
  
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  
  // Incident Details
  title       String
  description String
  severity    IncidentSeverity
  category    IncidentCategory
  
  // Timeline
  detectedAt  DateTime @default(now())
  reportedAt  DateTime?
  resolvedAt  DateTime?
  
  // Investigation
  affectedSystems Json?
  affectedUsers   Json?
  rootCause       String?
  
  // Response
  responseActions Json?
  status          IncidentStatus
  assignedTo      String?
  
  // Lessons Learned
  lessonsLearned  String?
  preventiveMeasures Json?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([workspaceId])
  @@index([severity])
  @@index([status])
  @@map("security_incidents")
}

enum IncidentSeverity {
  CRITICAL
  HIGH
  MEDIUM
  LOW
}

enum IncidentCategory {
  DATA_BREACH
  UNAUTHORIZED_ACCESS
  MALWARE
  PHISHING
  DOS_ATTACK
  INSIDER_THREAT
  MISCONFIGURATION
  OTHER
}

enum IncidentStatus {
  DETECTED
  INVESTIGATING
  CONTAINED
  RESOLVED
  CLOSED
}

// ========================================
// CQRS - EVENT SOURCING
// ========================================

model EventStoreEvent {
  id            String   @id @default(uuid())
  eventId       String   @unique
  aggregateId   String
  aggregateType String
  eventType     String
  version       Int
  timestamp     DateTime @default(now())
  payload       String   // JSON string
  metadata      String?  // JSON string
  archived      Boolean  @default(false)

  @@index([aggregateId])
  @@index([aggregateType])
  @@index([eventType])
  @@index([timestamp])
  @@map("event_store_events")
}

model EventStoreSnapshot {
  aggregateId   String   @id
  aggregateType String
  version       Int
  state         String   // JSON string
  timestamp     DateTime @default(now())

  @@index([aggregateType])
  @@index([timestamp])
  @@map("event_store_snapshots")
}

model SagaState {
  sagaId       String   @id @default(uuid())
  sagaType     String
  state        String   // JSON string
  context      String?  // JSON string
  currentStep  String?
  startedAt    DateTime @default(now())
  completedAt  DateTime?
  failedAt     DateTime?
  error        String?

  @@index([sagaType])
  @@index([state])
  @@map("saga_states")
}

// ========================================
// GAMIFICATION
// ========================================

model GamificationProfile {
  id        String   @id @default(uuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  xp        Int      @default(0)
  level     Int      @default(1)
  
  // Streaks
  currentStreak Int @default(0)
  longestStreak Int @default(0)
  lastActivityDate DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  badges       UserBadge[]
  achievements UserAchievement[]

  @@map("gamification_profiles")
}

model Badge {
  id          String   @id @default(uuid())
  slug        String   @unique
  name        String
  description String
  icon        String
  category    BadgeCategory
  rarity      BadgeRarity @default(COMMON)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users       UserBadge[]

  @@map("badges")
}

model UserBadge {
  id        String   @id @default(uuid())
  profileId String
  profile   GamificationProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  badgeId   String
  badge     Badge    @relation(fields: [badgeId], references: [id], onDelete: Cascade)
  
  earnedAt  DateTime @default(now())

  @@unique([profileId, badgeId])
  @@map("user_badges")
}

model Achievement {
  id          String   @id @default(uuid())
  slug        String   @unique
  name        String
  description String
  points      Int
  category    AchievementCategory
  criteria    Json // Logic to check if achieved
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users       UserAchievement[]

  @@map("achievements")
}

model UserAchievement {
  id            String   @id @default(uuid())
  profileId     String
  profile       GamificationProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  achievementId String
  achievement   Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)
  
  progress      Int      @default(0)
  completed     Boolean  @default(false)
  completedAt   DateTime?
  
  updatedAt     DateTime @updatedAt

  @@unique([profileId, achievementId])
  @@map("user_achievements")
}

enum BadgeCategory {
  ACHIEVEMENT
  MILESTONE
  SKILL
  SOCIAL
  SPECIAL
}

enum BadgeRarity {
  COMMON
  UNCOMMON
  RARE
  EPIC
  LEGENDARY
}

enum AchievementCategory {
  USAGE
  SOCIAL
  CREATION
  EXPLORATION
}

// ========================================
// IOT & EDGE COMPUTING
// ========================================

model IoTDevice {
  id String @id @default(uuid())

  // Workspace relationship
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  // Device details
  name       String
  deviceType String
  status     String @default("offline") // online, offline, warning, error
  
  // Configuration
  metadata   Json   @default("{}")
  location   Json?  // { lat, lng, address }
  tags       String[]
  
  // Timestamps
  lastSeen  DateTime @default(now())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  metrics    IoTMetric[]
  alerts     IoTAlert[]
  thresholds IoTThreshold[]
  commands   IoTCommandLog[]

  @@index([workspaceId])
  @@index([status])
  @@index([deviceType])
  @@map("iot_devices")
}

model IoTMetric {
  id String @id @default(uuid())

  // Device relationship
  deviceId String
  device   IoTDevice @relation(fields: [deviceId], references: [id], onDelete: Cascade)

  // Metric data
  timestamp DateTime
  metrics   Json // { temperature: 25.5, humidity: 60, etc }

  @@index([deviceId])
  @@index([timestamp])
  @@map("iot_metrics")
}

model IoTAlert {
  id String @id @default(uuid())

  // Device relationship
  deviceId String
  device   IoTDevice @relation(fields: [deviceId], references: [id], onDelete: Cascade)

  // Alert details
  type       String // threshold, anomaly, offline, error
  severity   String // info, warning, critical
  message    String
  timestamp  DateTime @default(now())
  
  // Status
  acknowledged   Boolean   @default(false)
  acknowledgedAt DateTime?
  acknowledgedBy String?

  @@index([deviceId])
  @@index([severity])
  @@index([acknowledged])
  @@map("iot_alerts")
}

model IoTThreshold {
  id String @id @default(uuid())

  // Device relationship
  deviceId String
  device   IoTDevice @relation(fields: [deviceId], references: [id], onDelete: Cascade)

  // Threshold configuration
  metricName String
  operator   String // gt, gte, lt, lte, eq
  value      Float
  severity   String @default("warning") // info, warning, critical
  enabled    Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([deviceId])
  @@map("iot_thresholds")
}

model IoTCommandLog {
  id String @id @default(uuid())

  // Device relationship
  deviceId String
  device   IoTDevice @relation(fields: [deviceId], references: [id], onDelete: Cascade)

  // Command details
  command  String
  payload  Json
  status   String // sent, acknowledged, executed, failed
  response Json?
  
  // Timestamps
  sentAt      DateTime @default(now())
  executedAt  DateTime?

  @@index([deviceId])
  @@index([sentAt])
  @@map("iot_command_logs")
}

model EdgeNode {
  id String @id @default(uuid())

  // Workspace relationship
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  // Node details
  name     String
  location String
  status   String @default("inactive") // active, inactive, maintenance

  // Configuration
  processingRules  Json @default("[]")
  dataFilters      Json @default("[]")
  aggregationConfig Json @default("{}")

  // Resources
  cpuUsage     Float @default(0)
  memoryUsage  Float @default(0)
  storageUsage Float @default(0)

  // Stats
  devicesConnected   Int @default(0)
  messagesProcessed  Int @default(0)
  
  // Timestamps
  lastHeartbeat DateTime @default(now())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([workspaceId])
  @@index([status])
  @@map("edge_nodes")
}

// ========================================
// ETL PIPELINES
// ========================================

model ETLPipeline {
  id String @id @default(uuid())

  // Workspace relationship
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  // Pipeline details
  name        String
  description String?
  
  // Pipeline configuration
  nodes  Json // Array of ETLNode
  edges  Json // Array of ETLEdge
  
  // Scheduling
  schedule Json? // { cron, timezone, enabled }
  
  // Status
  status String @default("draft") // draft, active, paused, error

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  executions ETLExecution[]

  @@index([workspaceId])
  @@index([status])
  @@map("etl_pipelines")
}

model ETLExecution {
  id String @id @default(uuid())

  // Pipeline relationship
  pipelineId String
  pipeline   ETLPipeline @relation(fields: [pipelineId], references: [id], onDelete: Cascade)

  // Execution details
  status        String // pending, running, completed, failed
  startedAt     DateTime
  completedAt   DateTime?
  rowsProcessed Int @default(0)
  
  // Results
  errors    String[]
  nodeStats Json @default("{}")

  @@index([pipelineId])
  @@index([startedAt])
  @@map("etl_executions")
}

// Rate limit configuration and metrics
model RateLimitConfig {
  integrationId String @id
  integration   Integration @relation(fields: [integrationId], references: [id], onDelete: Cascade)
  maxRequests   Int
  windowMs      Int
  burstLimit    Int?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("rate_limit_configs")
}

model RateLimitMetric {
  id            String   @id @default(uuid())
  integrationId String
  integration   Integration @relation(fields: [integrationId], references: [id], onDelete: Cascade)
  timestamp     DateTime @default(now())
  remainingQuota Int
  resetAt       DateTime

  @@map("rate_limit_metrics")
}

