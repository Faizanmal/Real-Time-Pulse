// Prisma Schema for Portal - Multi-Tenant B2B SaaS
// Database: PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========================================
// AUTHENTICATION & USER MANAGEMENT
// ========================================

model User {
  id        String  @id @default(uuid())
  email     String  @unique
  password  String? // Nullable for OAuth-only users
  firstName String?
  lastName  String?
  avatar    String?

  // OAuth providers
  googleId String? @unique

  // Email verification
  emailVerified Boolean @default(false)

  // Password reset
  resetToken       String?   @unique
  resetTokenExpiry DateTime?

  // Multi-tenant relationship
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  // Roles & Permissions
  role WorkspaceRole @default(MEMBER)

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  lastLoginAt DateTime?

  // Relations
  createdPortals     Portal[]
  shareLinks         ShareLink[]
  alerts             Alert[]
  scheduledReports   ScheduledReport[]
  webhooks           Webhook[]
  comments           Comment[]

  @@index([workspaceId])
  @@index([email])
  @@map("users")
}

enum WorkspaceRole {
  OWNER
  ADMIN
  MEMBER
}

// ========================================
// WORKSPACE (TENANT)
// ========================================

model Workspace {
  id   String @id @default(uuid())
  name String
  slug String @unique // URL-friendly name

  // Branding
  logo         String? // S3/R2 URL
  primaryColor String  @default("#3B82F6") // Hex color

  // Contact & Metadata
  contactEmail String?
  website      String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  users            User[]
  portals          Portal[]
  integrations     Integration[]
  subscription     Subscription?
  alerts           Alert[]
  scheduledReports ScheduledReport[]
  webhooks         Webhook[]
  aiInsights       AIInsight[]

  @@map("workspaces")
}

// ========================================
// SUBSCRIPTION & BILLING
// ========================================

model Subscription {
  id String @id @default(uuid())

  // Workspace relationship
  workspaceId String    @unique
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  // Stripe
  stripeCustomerId       String    @unique
  stripeSubscriptionId   String?   @unique
  stripePriceId          String?
  stripeCurrentPeriodEnd DateTime?

  // Plan details
  plan   SubscriptionPlan   @default(TRIAL)
  status SubscriptionStatus @default(TRIALING)

  // Limits
  maxPortals Int @default(5)
  maxUsers   Int @default(1)

  // Trial
  trialEndsAt DateTime?

  // Timestamps
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  canceledAt DateTime?

  @@index([workspaceId])
  @@index([stripeCustomerId])
  @@map("subscriptions")
}

enum SubscriptionPlan {
  TRIAL
  PRO // $49/mo - 5 portals, 1 user
  AGENCY // $99/mo - 15 portals, 5 users
}

enum SubscriptionStatus {
  TRIALING
  ACTIVE
  PAST_DUE
  CANCELED
  INCOMPLETE
  INCOMPLETE_EXPIRED
  UNPAID
}

// ========================================
// INTEGRATIONS (OAuth Connections)
// ========================================

model Integration {
  id String @id @default(uuid())

  // Workspace relationship
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  // Provider details
  provider IntegrationProvider

  // OAuth tokens (ENCRYPTED in application layer)
  accessToken  String    @db.Text
  refreshToken String?   @db.Text
  expiresAt    DateTime?

  // Provider-specific metadata
  accountId   String? // e.g., Asana workspace GID, GA property ID
  accountName String? // Display name
  scopes      String? // Granted OAuth scopes

  // Settings (JSON for provider-specific config)
  settings Json @default("{}")

  // Status
  status        IntegrationStatus @default(ACTIVE)
  lastSyncedAt  DateTime?
  lastSyncError String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  widgets Widget[]

  @@unique([workspaceId, provider])
  @@index([workspaceId])
  @@index([status])
  @@map("integrations")
}

enum IntegrationProvider {
  ASANA
  CLICKUP
  TRELLO
  GOOGLE_ANALYTICS
  GOOGLE_ANALYTICS_4
  HARVEST
  TOGGL
  GITHUB
  JIRA
  HUBSPOT
  SLACK
  MONDAY
  NOTION
  STRIPE
}

enum IntegrationStatus {
  ACTIVE
  INACTIVE
  ERROR
  EXPIRED
}

// ========================================
// PORTALS (The Core Product)
// ========================================

model Portal {
  id String @id @default(uuid())

  // Workspace relationship
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  // Portal details
  name        String
  slug        String // Unique per workspace - used in public URL
  description String?

  // Public sharing
  isPublic   Boolean @default(true)
  shareToken String  @unique @default(uuid()) // Used in public URL: portal.to/v/{shareToken}

  // Layout configuration (JSON)
  layout Json @default("[]") // Array of widget positions/sizes for react-grid-layout

  // Creator
  createdById String
  createdBy   User   @relation(fields: [createdById], references: [id], onDelete: Cascade)

  // Cache settings
  cacheRefreshInterval Int       @default(30) // Minutes
  lastCachedAt         DateTime?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  widgets          Widget[]
  shareLinks       ShareLink[]
  scheduledReports ScheduledReport[]
  aiInsights       AIInsight[]

  @@unique([workspaceId, slug])
  @@index([workspaceId])
  @@index([shareToken])
  @@map("portals")
}

// ========================================
// WIDGETS (Portal Building Blocks)
// ========================================

model Widget {
  id String @id @default(uuid())

  // Portal relationship
  portalId String
  portal   Portal @relation(fields: [portalId], references: [id], onDelete: Cascade)

  // Widget details
  name String

  // Widget type
  type WidgetType

  // Configuration (JSON - varies by widget type)
  config Json @default("{}")
  // Examples:
  // Text: { content: "...", format: "markdown" }
  // Asana Task List: { projectId: "...", filter: "in_progress" }
  // GA Metric: { metric: "users", period: "30d" }

  // Grid position (redundant with portal.layout, but useful for queries)
  gridX      Int @default(0)
  gridY      Int @default(0)
  gridWidth  Int @default(4)
  gridHeight Int @default(4)

  // Refresh settings
  refreshInterval Int       @default(300) // Seconds
  lastRefreshedAt DateTime?

  // Integration relationship (optional)
  integrationId String?
  integration   Integration? @relation(fields: [integrationId], references: [id], onDelete: SetNull)

  // Display order
  order Int @default(0)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([portalId])
  @@index([integrationId])
  @@map("widgets")
}

enum WidgetType {
  // Static widgets
  TEXT_BLOCK
  IMAGE
  VIDEO_EMBED

  // Asana widgets
  ASANA_TASK_LIST
  ASANA_PROJECT_PROGRESS

  // ClickUp widgets
  CLICKUP_TASK_LIST
  CLICKUP_PROJECT_PROGRESS

  // Trello widgets
  TRELLO_CARD_LIST
  TRELLO_BOARD_PROGRESS

  // Google Analytics 4 widgets
  GA4_METRIC_KPI
  GA4_LINE_GRAPH
  GA4_TOP_PAGES

  // Harvest widgets
  HARVEST_BUDGET_TRACKER
  HARVEST_TOTAL_HOURS

  // Toggl widgets
  TOGGL_TOTAL_HOURS
}

// ========================================
// CACHE STORAGE (For fast public portal loads)
// ========================================
// Note: Actual cache data stored in Redis
// This table stores metadata about cache jobs

model CacheJob {
  id String @id @default(uuid())

  // Portal reference
  portalId String

  // Job status
  status CacheJobStatus @default(PENDING)

  // Error tracking
  error      String?
  retryCount Int     @default(0)
  maxRetries Int     @default(3)

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  startedAt   DateTime?
  completedAt DateTime?
  failedAt    DateTime?

  @@index([portalId])
  @@index([status])
  @@map("cache_jobs")
}

enum CacheJobStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
}

// ========================================
// AUDIT LOGS (Enterprise Security Feature)
// ========================================

model AuditLog {
  id String @id @default(uuid())

  // Workspace & User tracking
  workspaceId String
  userId      String?
  userEmail   String

  // Action details
  action   AuditAction
  entity   String // e.g., "Portal", "Widget", "User"
  entityId String // ID of the affected resource

  // Request metadata
  ipAddress String?
  userAgent String?
  method    String // HTTP method: GET, POST, PUT, DELETE
  endpoint  String // API endpoint called

  // Changes tracking (JSON)
  oldValues Json? // Previous state
  newValues Json? // New state

  // Additional metadata
  metadata Json? // Any extra context

  // Status
  success      Boolean @default(true)
  errorMessage String?

  // Timestamp
  createdAt DateTime @default(now())

  @@index([workspaceId])
  @@index([userId])
  @@index([action])
  @@index([entity])
  @@index([createdAt])
  @@map("audit_logs")
}

enum AuditAction {
  // Authentication
  LOGIN
  LOGOUT
  PASSWORD_RESET

  // CRUD operations
  CREATE
  READ
  UPDATE
  DELETE

  // Specific actions
  INVITE_USER
  REMOVE_USER
  UPLOAD_FILE
  EXPORT_DATA
  CHANGE_SETTINGS
  CONNECT_INTEGRATION
  DISCONNECT_INTEGRATION
}

// ========================================
// ANALYTICS & TRACKING
// ========================================

model AnalyticsEvent {
  id String @id @default(uuid())

  // Workspace & Portal tracking
  workspaceId String
  portalId    String?
  widgetId    String?

  // User tracking
  userId    String?
  sessionId String // Browser session ID

  // Event details
  eventType String // e.g., "portal_view", "widget_click", "widget_view"
  eventData Json? // Additional event-specific data

  // Request metadata
  ipAddress String?
  userAgent String?
  referrer  String? // Where the user came from

  // Timestamp
  timestamp DateTime @default(now())

  @@index([workspaceId])
  @@index([portalId])
  @@index([widgetId])
  @@index([eventType])
  @@index([timestamp])
  @@index([sessionId])
  @@map("analytics_events")
}

// ========================================
// WORKSPACE MEMBERS (Enhanced RBAC)
// ========================================

model WorkspaceMember {
  id String @id @default(uuid())

  // Relationships
  workspaceId String
  userId      String

  // Role & Permissions
  role WorkspaceMemberRole @default(VIEWER)

  // Invitation tracking
  invitedBy  String?
  invitedAt  DateTime  @default(now())
  acceptedAt DateTime?

  // Status
  status MemberStatus @default(PENDING)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([workspaceId, userId])
  @@index([workspaceId])
  @@index([userId])
  @@map("workspace_members")
}

enum WorkspaceMemberRole {
  OWNER
  ADMIN
  EDITOR
  VIEWER
}

enum MemberStatus {
  PENDING
  ACTIVE
  SUSPENDED
}

// ========================================
// BACKGROUND JOBS METADATA
// ========================================

model JobMetadata {
  id String @id @default(uuid())

  // Job details
  jobId     String @unique // BullMQ job ID
  queueName String // Which queue: email, report, data-sync
  jobType   String // Specific job type

  // Workspace tracking
  workspaceId String
  userId      String?

  // Status
  status   JobStatus @default(QUEUED)
  progress Int       @default(0) // 0-100

  // Timing
  queuedAt    DateTime  @default(now())
  startedAt   DateTime?
  completedAt DateTime?
  failedAt    DateTime?

  // Results
  result Json? // Job result data
  error  String? // Error message if failed

  // Metadata
  metadata Json? // Additional context

  @@index([workspaceId])
  @@index([userId])
  @@index([status])
  @@index([queueName])
  @@map("job_metadata")
}

enum JobStatus {
  QUEUED
  ACTIVE
  COMPLETED
  FAILED
  DELAYED
  PAUSED
}

// ========================================
// NOTIFICATIONS
// ========================================

model Notification {
  id String @id @default(uuid())

  // Recipient
  userId      String
  workspaceId String

  // Notification details
  title   String
  message String
  type    NotificationType

  // Action link
  actionUrl String?

  // Status
  read   Boolean   @default(false)
  readAt DateTime?

  // Related entities
  portalId String?
  widgetId String?

  // Metadata
  metadata Json?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([workspaceId])
  @@index([read])
  @@index([createdAt])
  @@map("notifications")
}

enum NotificationType {
  INFO
  SUCCESS
  WARNING
  ERROR
  PORTAL_CREATED
  PORTAL_UPDATED
  PORTAL_DELETED
  WIDGET_ADDED
  WIDGET_UPDATED
  MEMBER_INVITED
  INTEGRATION_SYNCED
  INTEGRATION_FAILED
  ALERT_TRIGGERED
  REPORT_GENERATED
}

// ========================================
// PUBLIC SHARE LINKS
// ========================================

model ShareLink {
  id String @id @default(uuid())

  // Portal reference
  portalId String
  portal   Portal @relation(fields: [portalId], references: [id], onDelete: Cascade)

  // Share token (URL-friendly)
  token String @unique @default(uuid())

  // Access control
  password     String? // Hashed password for protected links
  expiresAt    DateTime?
  maxViews     Int? // Limit number of views
  currentViews Int       @default(0)

  // Permissions
  allowExport   Boolean @default(false) // Allow export from shared link
  allowComments Boolean @default(false)

  // Creator
  createdById String
  createdBy   User   @relation(fields: [createdById], references: [id], onDelete: Cascade)

  // Status
  isActive Boolean @default(true)

  // Analytics
  lastAccessedAt DateTime?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([portalId])
  @@index([token])
  @@index([isActive])
  @@map("share_links")
}

// ========================================
// ALERTS & MONITORING
// ========================================

model Alert {
  id String @id @default(uuid())

  // Workspace & Portal
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  portalId    String?
  widgetId    String?

  // Alert configuration
  name        String
  description String?
  condition   Json // {metric: "value", operator: ">", threshold: 100}
  
  // Notification channels
  channels Json // ["email", "slack", "webhook"]
  
  // Email settings
  emailRecipients String[] // List of emails
  
  // Webhook settings
  webhookUrl String?
  
  // Slack settings
  slackWebhook String?
  slackChannel String?

  // Status
  isActive Boolean @default(true)
  
  // Tracking
  lastTriggeredAt DateTime?
  triggerCount    Int       @default(0)

  // Creator
  createdById String
  createdBy   User   @relation(fields: [createdById], references: [id], onDelete: Cascade)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  history AlertHistory[]

  @@index([workspaceId])
  @@index([portalId])
  @@index([isActive])
  @@map("alerts")
}

model AlertHistory {
  id String @id @default(uuid())

  // Alert reference
  alertId String
  alert   Alert  @relation(fields: [alertId], references: [id], onDelete: Cascade)

  // Trigger details
  triggeredValue Json // The actual value that triggered the alert
  condition      Json // Copy of condition at trigger time
  
  // Notification status
  notificationsSent Json // {email: true, slack: false, webhook: true}
  
  // Timestamp
  triggeredAt DateTime @default(now())

  @@index([alertId])
  @@index([triggeredAt])
  @@map("alert_history")
}

// ========================================
// SCHEDULED REPORTS
// ========================================

model ScheduledReport {
  id String @id @default(uuid())

  // Workspace & Portal
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  portalId    String
  portal      Portal    @relation(fields: [portalId], references: [id], onDelete: Cascade)

  // Report configuration
  name        String
  description String?
  format      ReportFormat @default(PDF)
  
  // Schedule (cron expression)
  schedule String // e.g., "0 9 * * 1" for every Monday at 9 AM
  timezone String @default("UTC")

  // Recipients
  recipients String[] // Email addresses
  
  // Template
  templateId String?
  customTemplate Json? // Custom report template configuration

  // Status
  isActive Boolean @default(true)
  
  // Tracking
  lastRunAt     DateTime?
  nextRunAt     DateTime?
  lastRunStatus ReportStatus?
  runCount      Int          @default(0)

  // Creator
  createdById String
  createdBy   User   @relation(fields: [createdById], references: [id], onDelete: Cascade)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  runs ReportRun[]

  @@index([workspaceId])
  @@index([portalId])
  @@index([isActive])
  @@index([nextRunAt])
  @@map("scheduled_reports")
}

model ReportRun {
  id String @id @default(uuid())

  // Report reference
  reportId String
  report   ScheduledReport @relation(fields: [reportId], references: [id], onDelete: Cascade)

  // Execution details
  status    ReportStatus @default(PENDING)
  startedAt DateTime?
  completedAt DateTime?
  
  // Output
  fileUrl String? // S3/R2 URL if stored
  fileSize Int? // Bytes
  
  // Error tracking
  error String?
  
  // Metadata
  recipientsSent String[] // Successfully sent to these emails
  metadata       Json?

  // Timestamp
  createdAt DateTime @default(now())

  @@index([reportId])
  @@index([status])
  @@index([createdAt])
  @@map("report_runs")
}

enum ReportFormat {
  PDF
  CSV
  EXCEL
  JSON
}

enum ReportStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
  PARTIALLY_SENT
}

// ========================================
// WEBHOOKS
// ========================================

model Webhook {
  id String @id @default(uuid())

  // Workspace
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  // Webhook configuration
  name        String
  url         String
  secret      String? // For signature verification
  events      String[] // List of events to subscribe to
  
  // Headers
  headers Json? // Custom headers to send
  
  // Retry configuration
  maxRetries     Int @default(3)
  retryDelay     Int @default(60) // Seconds
  timeoutSeconds Int @default(30)

  // Status
  isActive Boolean @default(true)
  
  // Tracking
  lastTriggeredAt DateTime?
  successCount    Int       @default(0)
  failureCount    Int       @default(0)

  // Creator
  createdById String
  createdBy   User   @relation(fields: [createdById], references: [id], onDelete: Cascade)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  deliveries WebhookDelivery[]

  @@index([workspaceId])
  @@index([isActive])
  @@map("webhooks")
}

model WebhookDelivery {
  id String @id @default(uuid())

  // Webhook reference
  webhookId String
  webhook   Webhook @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  // Event details
  event     String
  payload   Json
  
  // Delivery attempt
  attempts      Int       @default(0)
  lastAttemptAt DateTime?
  nextAttemptAt DateTime?
  
  // Response
  status         WebhookStatus @default(PENDING)
  responseCode   Int?
  responseBody   String?
  responseTime   Int? // Milliseconds
  
  // Error
  error String?

  // Timestamp
  createdAt DateTime @default(now())

  @@index([webhookId])
  @@index([status])
  @@index([event])
  @@index([nextAttemptAt])
  @@map("webhook_deliveries")
}

enum WebhookStatus {
  PENDING
  SUCCESS
  FAILED
  RETRYING
}

// ========================================
// COMMENTS & COLLABORATION
// ========================================

model Comment {
  id String @id @default(uuid())

  // Location
  portalId String
  widgetId String?
  
  // Author
  authorId String
  author   User   @relation(fields: [authorId], references: [id], onDelete: Cascade)

  // Content
  content  String   @db.Text
  mentions String[] // User IDs mentioned in comment
  
  // Thread
  parentId String?
  parent   Comment?  @relation("CommentThread", fields: [parentId], references: [id], onDelete: Cascade)
  replies  Comment[] @relation("CommentThread")
  
  // Status
  isEdited  Boolean   @default(false)
  isDeleted Boolean   @default(false)
  editedAt  DateTime?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([portalId])
  @@index([widgetId])
  @@index([authorId])
  @@index([parentId])
  @@map("comments")
}

// ========================================
// AI INSIGHTS
// ========================================

model AIInsight {
  id String @id @default(uuid())

  // Workspace & Portal
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  portalId    String
  portal      Portal    @relation(fields: [portalId], references: [id], onDelete: Cascade)

  // Insight details
  type        InsightType
  title       String
  description String      @db.Text
  severity    InsightSeverity @default(INFO)
  confidence  Float // 0.0 to 1.0
  
  // Data
  data Json // Supporting data for the insight
  
  // Recommendations
  recommendations Json? // Suggested actions
  
  // Status
  status     InsightStatus @default(NEW)
  dismissedBy String?
  dismissedAt DateTime?
  
  // Validity
  validFrom DateTime @default(now())
  validUntil DateTime?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([workspaceId])
  @@index([portalId])
  @@index([type])
  @@index([status])
  @@map("ai_insights")
}

enum InsightType {
  ANOMALY
  TREND
  PREDICTION
  RECOMMENDATION
  SUMMARY
}

enum InsightSeverity {
  INFO
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum InsightStatus {
  NEW
  VIEWED
  ACTIONED
  DISMISSED
}

// ========================================
// WIDGET TEMPLATES
// ========================================

model WidgetTemplate {
  id String @id @default(uuid())

  // Template details
  name        String
  description String?
  category    TemplateCategory
  thumbnail   String? // Preview image URL

  // Template configuration
  widgetType WidgetType
  config     Json // Default widget configuration
  layout     Json? // Default grid layout settings

  // Visibility
  isPublic    Boolean @default(false) // Available to all users
  workspaceId String? // Null if public template
  
  // Creator (null for system templates)
  createdById String?
  
  // Usage tracking
  usageCount Int @default(0)

  // Tags for filtering
  tags String[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category])
  @@index([widgetType])
  @@index([isPublic])
  @@index([workspaceId])
  @@map("widget_templates")
}

enum TemplateCategory {
  PROJECT_MANAGEMENT
  ANALYTICS
  TIME_TRACKING
  MARKETING
  SALES
  DEVELOPMENT
  CUSTOM
}

// ========================================
// BILLING & USAGE
// ========================================

model BillingEvent {
  id String @id @default(uuid())

  // Workspace
  workspaceId String
  
  // Stripe references
  stripeEventId      String? @unique
  stripeInvoiceId    String?
  stripePaymentIntentId String?
  
  // Event details
  type        BillingEventType
  amount      Int? // In cents
  currency    String @default("usd")
  description String?
  
  // Status
  status BillingEventStatus @default(PENDING)
  
  // Metadata
  metadata Json?

  // Timestamp
  createdAt DateTime @default(now())

  @@index([workspaceId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
  @@map("billing_events")
}

enum BillingEventType {
  SUBSCRIPTION_CREATED
  SUBSCRIPTION_UPDATED
  SUBSCRIPTION_CANCELED
  INVOICE_PAID
  INVOICE_FAILED
  PAYMENT_SUCCEEDED
  PAYMENT_FAILED
  TRIAL_ENDED
  PLAN_UPGRADED
  PLAN_DOWNGRADED
}

enum BillingEventStatus {
  PENDING
  COMPLETED
  FAILED
}

model UsageMetric {
  id String @id @default(uuid())

  // Workspace
  workspaceId String
  
  // Metric details
  metricType  UsageMetricType
  value       Float
  unit        String? // e.g., "count", "bytes", "ms"
  
  // Resource references
  portalId String?
  widgetId String?
  userId   String?
  
  // Time bucket
  period     DateTime // Rounded to hour/day for aggregation
  periodType PeriodType @default(HOURLY)
  
  // Metadata
  metadata Json?

  // Timestamp
  createdAt DateTime @default(now())

  @@index([workspaceId])
  @@index([metricType])
  @@index([period])
  @@index([portalId])
  @@map("usage_metrics")
}

enum UsageMetricType {
  PORTAL_VIEWS
  WIDGET_LOADS
  API_CALLS
  EXPORT_COUNT
  STORAGE_BYTES
  INTEGRATION_SYNCS
  REPORT_GENERATIONS
  AI_INSIGHTS_GENERATED
  BANDWIDTH_BYTES
  ACTIVE_USERS
}

enum PeriodType {
  HOURLY
  DAILY
  WEEKLY
  MONTHLY
}

// ========================================
// PORTAL TEMPLATES (Full Dashboard)
// ========================================

model PortalTemplate {
  id String @id @default(uuid())

  // Template details
  name        String
  description String?
  category    TemplateCategory
  thumbnail   String? // Preview image URL

  // Template configuration
  layout        Json // Widget layout configuration
  widgetConfigs Json // Array of widget configurations
  settings      Json? // Portal-level settings

  // Visibility
  isPublic    Boolean @default(false)
  workspaceId String? // Null if public template
  
  // Creator (null for system templates)
  createdById String?
  
  // Usage tracking
  usageCount Int @default(0)

  // Tags for filtering
  tags String[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category])
  @@index([isPublic])
  @@index([workspaceId])
  @@map("portal_templates")
}
